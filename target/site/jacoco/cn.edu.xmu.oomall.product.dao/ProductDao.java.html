<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ProductDao.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">product</a> &gt; <a href="index.source.html" class="el_package">cn.edu.xmu.oomall.product.dao</a> &gt; <span class="el_source">ProductDao.java</span></div><h1>ProductDao.java</h1><pre class="source lang-java linenums">//School of Informatics Xiamen University, GPL-3.0 license
package cn.edu.xmu.oomall.product.dao;

import cn.edu.xmu.javaee.core.exception.BusinessException;
import cn.edu.xmu.javaee.core.model.InternalReturnObject;
import cn.edu.xmu.javaee.core.model.ReturnNo;
import cn.edu.xmu.javaee.core.model.vo.PageVo;
import cn.edu.xmu.javaee.core.model.dto.UserDto;
import cn.edu.xmu.javaee.core.util.CloneFactory;
import cn.edu.xmu.javaee.core.mapper.RedisUtil;
import cn.edu.xmu.oomall.product.dao.bo.Category;
import cn.edu.xmu.oomall.product.dao.bo.OnSale;
import cn.edu.xmu.oomall.product.dao.bo.Product;
import cn.edu.xmu.oomall.product.dao.onsale.*;
import cn.edu.xmu.oomall.product.dao.openfeign.FreightDao;
import cn.edu.xmu.oomall.product.dao.openfeign.ShopDao;
import cn.edu.xmu.oomall.product.dao.openfeign.TemplateDao;
import cn.edu.xmu.oomall.product.mapper.jpa.ProductPoMapper;
import cn.edu.xmu.oomall.product.mapper.openfeign.SearchMapper;
import cn.edu.xmu.oomall.product.mapper.po.ProductPo;
import lombok.NoArgsConstructor;
import lombok.RequiredArgsConstructor;
import lombok.ToString;
import org.apache.commons.lang3.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.cloud.context.config.annotation.RefreshScope;
import org.springframework.data.domain.*;
import org.springframework.stereotype.Repository;

import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;
import java.util.Objects;
import java.util.Optional;
import java.util.stream.Collectors;

import static cn.edu.xmu.javaee.core.model.Constants.*;

/**
 * @author Ming Qiu
 **/
@Repository
@RefreshScope
@RequiredArgsConstructor
public class ProductDao {

<span class="fc" id="L49">    private final static Logger logger = LoggerFactory.getLogger(ProductDao.class);</span>

    private final static String KEY = &quot;P%d&quot;;

    private final static String OTHER_KEY = &quot;PO%d&quot;;

    @Value(&quot;${oomall.product.timeout}&quot;)
    private int timeout;

    private final ProductPoMapper productPoMapper;
    private final OnSaleDao onsaleDao;
    private final CategoryDao categoryDao;
    private final ShopDao shopDao;
    private final FreightDao freightDao;
    private final TemplateDao templateDao;
    private final RedisUtil redisUtil;

    private final SearchMapper searchMapper;


    /**
     * 用id查找产品对象，关联有效的onsale对象
     *
     * @param id product Id
     * @return product对象
     */
    public Product findValidById(Long shopId, Long id) throws RuntimeException {
<span class="fc" id="L76">        logger.debug(&quot;findValidById: id = {}&quot;, id);</span>
<span class="fc" id="L77">        String key = String.format(KEY, id);</span>
<span class="fc" id="L78">        ValidOnSaleProductFactory factory = new ValidOnSaleProductFactory(id);</span>
        Product bo;
<span class="pc bpc" id="L80" title="1 of 2 branches missed.">        if (this.redisUtil.hasKey(key)) {</span>
<span class="nc" id="L81">            bo = (Product) this.redisUtil.get(key);</span>
<span class="nc bnc" id="L82" title="All 4 branches missed.">            if (!Objects.equals(shopId, bo.getShopId()) &amp;&amp; !PLATFORM.equals(shopId)){</span>
<span class="nc" id="L83">                throw new BusinessException(ReturnNo.RESOURCE_ID_OUTSCOPE, String.format(ReturnNo.RESOURCE_ID_OUTSCOPE.getMessage(), &quot;产品&quot;, id, shopId));</span>
            }
<span class="nc" id="L85">            bo = factory.build(bo);</span>
        }else {
<span class="fc" id="L87">            bo = this.findBo(shopId, id, factory);</span>
        }
<span class="fc" id="L89">        return bo;</span>
    }

    /**
     * 用onsaleid查找Product对象
     * 缓存product对象
     *
     * @param  onsale
     * @return product对象
     */
    public Product findByOnsale(OnSale onsale) throws RuntimeException {
<span class="fc" id="L100">        logger.debug(&quot;findOnsaleById: id = {}&quot;, onsale.getId());</span>
<span class="pc bpc" id="L101" title="1 of 2 branches missed.">        if (null == onsale.getId()){</span>
<span class="nc" id="L102">            throw new IllegalArgumentException(&quot;ProductDao.findProductByOnsaleId: onsaleId can not be null&quot;);</span>
        }
<span class="fc" id="L104">        SpecOnSaleProductFactory factory = new SpecOnSaleProductFactory(onsale.getId());</span>
<span class="fc" id="L105">        return this.findBo(PLATFORM, onsale.getProductId(), factory);</span>
    }

    /**
     * 用id查找Product对象（不关联onsale对象）
     * 不缓存
     * @param shopId 商铺id
     * @param id 产品id
     *
     * @return product对象
     */
    public Product findNoOnsaleById(Long shopId, Long id) throws RuntimeException {
<span class="fc" id="L117">        logger.debug(&quot;findNoOnsaleById: id = {}&quot;, id);</span>
<span class="pc bpc" id="L118" title="1 of 4 branches missed.">        if (null == id &amp;&amp; null == shopId) {</span>
<span class="fc" id="L119">            throw new IllegalArgumentException(&quot;ProductDao.findNoOnsaleById: product id can not be null&quot;);</span>
        }
<span class="fc" id="L121">        NoOnSaleProductFactory factory = new NoOnSaleProductFactory();</span>
<span class="fc" id="L122">        return this.findBo(shopId, id, factory);</span>
    }

    /**
     * 按照不同的build方法获得bo对象
     *
     * @param shopId 商铺id
     * @param productId 产品id
     * @param factory 不同的getBo函数接口
     * @return Product 对象
     * @author Ming Qiu
     * &lt;p&gt;
     * date: 2022-12-11 7:05
     */
    private Product findBo(Long shopId, Long productId, ProductFactory factory) {
<span class="fc" id="L137">        Optional&lt;ProductPo&gt; ret = this.productPoMapper.findById(productId);</span>
<span class="fc bfc" id="L138" title="All 2 branches covered.">        if (ret.isPresent()) {</span>
<span class="fc" id="L139">            ProductPo po = ret.get();</span>
<span class="fc bfc" id="L140" title="All 4 branches covered.">            if (!Objects.equals(shopId, po.getShopId()) &amp;&amp; !PLATFORM.equals(shopId)){</span>
<span class="fc" id="L141">                throw new BusinessException(ReturnNo.RESOURCE_ID_OUTSCOPE, String.format(ReturnNo.RESOURCE_ID_OUTSCOPE.getMessage(), &quot;产品&quot;, productId, shopId));</span>
            }
<span class="fc" id="L143">            String key = String.format(KEY, productId);</span>
<span class="fc" id="L144">            return factory.build(po, Optional.of(key));</span>
        } else {
<span class="fc" id="L146">            throw new BusinessException(ReturnNo.RESOURCE_ID_NOTEXIST, String.format(ReturnNo.RESOURCE_ID_NOTEXIST.getMessage(), &quot;产品&quot;, productId));</span>
        }
    }


    /**
     * 用GoodsPo对象找Goods对象
     *
     * @param name
     * @return Goods对象列表，带关联的Product返回
     */
    public PageVo&lt;Product&gt; retrieveProductByName(String name, int page, int pageSize) throws RuntimeException {
<span class="nc" id="L158">        List&lt;Product&gt; productList = null;</span>
<span class="nc" id="L159">        Pageable pageable = PageRequest.of(page, pageSize);</span>
<span class="nc" id="L160">        Page&lt;ProductPo&gt; pageObj = productPoMapper.findByNameEqualsAndStatusNot(name, Product.BANNED, pageable);</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">        if (!pageObj.isEmpty()) {</span>
<span class="nc" id="L162">            productList = pageObj.stream().map(po -&gt; {</span>
<span class="nc" id="L163">                ValidOnSaleProductFactory factory = new ValidOnSaleProductFactory(po.getId());</span>
<span class="nc" id="L164">                return factory.build(po, Optional.ofNullable(null));</span>
<span class="nc" id="L165">            }).collect(Collectors.toList());</span>
        } else {
<span class="nc" id="L167">            productList = new ArrayList&lt;&gt;();</span>
        }
<span class="nc" id="L169">        logger.debug(&quot;retrieveProductByName: productList = {}&quot;, productList);</span>
<span class="nc" id="L170">        return new PageVo&lt;&gt;(productList, page, pageSize);</span>
    }


    /**
     * 用id查找对象
     *
     * @param goodsId goodsId
     * @return product对象
     */
    public List&lt;Product&gt; retrieveOtherProductById(Long shopId, Long goodsId) throws RuntimeException {
<span class="fc" id="L181">        String key = String.format(OTHER_KEY, goodsId);</span>
<span class="fc" id="L182">        List&lt;Long&gt; otherIds = (List&lt;Long&gt;) redisUtil.get(key);</span>
<span class="pc bpc" id="L183" title="1 of 2 branches missed.">        if (!Objects.isNull(otherIds)) {</span>
<span class="nc" id="L184">            return retrievePatchProduct(shopId,otherIds);</span>
        }

<span class="fc" id="L187">        Pageable pageable = PageRequest.of(0, MAX_RETURN);</span>
<span class="fc" id="L188">        Page&lt;ProductPo&gt; ret = productPoMapper.findByGoodsIdEquals(goodsId, pageable);</span>
<span class="pc bpc" id="L189" title="1 of 2 branches missed.">        if (ret.isEmpty()) {</span>
<span class="nc" id="L190">            return new ArrayList&lt;&gt;();</span>
        } else {
<span class="fc" id="L192">            List&lt;Product&gt; retList = ret.stream().map(productPo -&gt; {</span>
<span class="fc" id="L193">                String keyP = String.format(KEY, productPo.getId());</span>
<span class="fc" id="L194">                ValidOnSaleProductFactory validOnsaleProductFactory = new ValidOnSaleProductFactory(productPo.getId());</span>
<span class="fc" id="L195">                Product bo = validOnsaleProductFactory.build(productPo, Optional.empty());</span>
<span class="fc" id="L196">                redisUtil.set(keyP,bo,timeout);</span>
<span class="fc" id="L197">                return bo;</span>
<span class="fc" id="L198">            }).collect(Collectors.toList());</span>
<span class="fc" id="L199">            redisUtil.set(key, (ArrayList&lt;Long&gt;) retList.stream().map(obj -&gt; obj.getId()).collect(Collectors.toList()), timeout);</span>
<span class="fc" id="L200">            return retList;</span>
        }
    }

    /**
     * 批查询的结果处理
     *
     * @param shopId
     * @param otherIds
     * @return
     */
    private List&lt;Product&gt; retrievePatchProduct(Long shopId, List&lt;Long&gt; otherIds) {

<span class="nc" id="L213">        List&lt;String&gt; keyList = otherIds.stream().map(id-&gt; String.format(KEY,id)).collect(Collectors.toList());</span>
<span class="nc" id="L214">        List&lt;Object&gt; results = redisUtil.getByList(keyList);</span>
<span class="nc" id="L215">        List&lt;Product&gt; productList = new ArrayList&lt;&gt;();</span>

        // 处理管道中的结果
<span class="nc bnc" id="L218" title="All 2 branches missed.">        for (int i = 0; i &lt; results.size(); i += 2) {</span>
<span class="nc" id="L219">            boolean existsInCache = (Boolean) results.get(i);</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">            if (existsInCache) {</span>
<span class="nc" id="L221">                Product productTemp = (Product) results.get(i + 1);</span>
<span class="nc" id="L222">                ValidOnSaleProductFactory factory = new ValidOnSaleProductFactory(productTemp.getId());</span>
<span class="nc" id="L223">                productTemp = factory.build(productTemp);</span>
<span class="nc bnc" id="L224" title="All 4 branches missed.">                if (!Objects.equals(shopId, productTemp.getShopId()) &amp;&amp; !PLATFORM.equals(shopId)){</span>
<span class="nc" id="L225">                    throw new BusinessException(ReturnNo.RESOURCE_ID_OUTSCOPE, String.format(ReturnNo.RESOURCE_ID_OUTSCOPE.getMessage(), &quot;产品&quot;, productTemp.getId(), shopId));</span>
                }
<span class="nc" id="L227">                productList.add(productTemp);</span>
            }
        }

<span class="nc" id="L231">        return productList;</span>

    }



    @ToString
    @NoArgsConstructor
    public abstract class ProductFactory{

        public Product build(ProductPo po, Optional&lt;String&gt; redisKey) {
<span class="fc" id="L242">            Product bo = CloneFactory.copy(new Product(), po);</span>
<span class="fc" id="L243">            this.build(bo);</span>
<span class="fc" id="L244">            redisKey.ifPresent(key -&gt; redisUtil.set(key, bo, timeout));</span>
<span class="fc" id="L245">            return bo;</span>
        }

        public Product build(Product bo) {
<span class="fc" id="L249">            bo.setCategoryDao(categoryDao);</span>
<span class="fc" id="L250">            bo.setProductDao(ProductDao.this);</span>
<span class="fc" id="L251">            bo.setShopDao(shopDao);</span>
<span class="fc" id="L252">            bo.setFreightDao(freightDao);</span>
<span class="fc" id="L253">            bo.setTemplateDao(templateDao);</span>
<span class="fc" id="L254">            bo.setOnsaleExecutor(this.getExecutor());</span>
<span class="fc" id="L255">            return bo;</span>
        }

        protected abstract OnSaleExecutor getExecutor();
    }

    /**
     * 生产特定历史销售信息Product
     */
    public class SpecOnSaleProductFactory extends ProductFactory {

        private Long onsaleId;

<span class="fc" id="L268">        public SpecOnSaleProductFactory(Long onsaleId) {</span>
<span class="fc" id="L269">            super();</span>
<span class="fc" id="L270">            this.onsaleId = onsaleId;</span>
<span class="fc" id="L271">        }</span>

        @Override
        protected OnSaleExecutor getExecutor() {
<span class="fc" id="L275">            return new SpecOnSaleExecutor(onsaleDao, this.onsaleId);</span>
        }
    }

    /**
     * 生产当前有效销售信息Product
     */
    @ToString(callSuper = true)
    public class ValidOnSaleProductFactory extends ProductFactory {

        private Long productId;

<span class="fc" id="L287">        public ValidOnSaleProductFactory(Long productId) {</span>
<span class="fc" id="L288">            super();</span>
<span class="fc" id="L289">            this.productId = productId;</span>
<span class="fc" id="L290">        }</span>

        @Override
        protected OnSaleExecutor getExecutor() {
<span class="fc" id="L294">            return new ValidOnSaleExecutor(onsaleDao, this.productId);</span>
        }
    }

    /**
     * 生产不附带Onsale的Product
     */
    @ToString(callSuper = true)
    public class NoOnSaleProductFactory extends ProductFactory {

<span class="fc" id="L304">        public NoOnSaleProductFactory() {</span>
<span class="fc" id="L305">            super();</span>
<span class="fc" id="L306">        }</span>

        @Override
        protected OnSaleExecutor getExecutor() {
<span class="fc" id="L310">            return new NoOnSaleExecutor();</span>
        }
    }

//    /**
//     * 根据店铺id、条形码和名称查找商品
//     * 如果非空则and查询
//     * @param shopId 商铺id 精确
//     * @param barCode 条码 忽略大小写
//     * @param name 商品名称 按照开头模糊查询
//     * @param page
//     * @param pageSize
//     * @return
//     */
//    public List&lt;Product&gt; retrieveByShopIdAndBarCodeAndName(Long shopId, String barCode, String name, Integer page, Integer pageSize) {
//        List&lt;Product&gt; ret = new ArrayList&lt;&gt;();
//        Pageable pageable = PageRequest.of(page - 1, pageSize);
//
//        ProductPo queryExample = new ProductPo();
//        if (StringUtils.isNoneBlank(name)){
//            queryExample.setName(name);
//        }
//        if (StringUtils.isNoneBlank(barCode)){
//            queryExample.setBarcode(barCode);
//        }
//        if (null != shopId){
//            queryExample.setShopId(shopId);
//        }
//
//        ExampleMatcher matcher = ExampleMatcher.matching()
//                .withMatcher(&quot;name&quot;, ExampleMatcher.GenericPropertyMatchers.startsWith())
//                .withMatcher(&quot;barcode&quot;, ExampleMatcher.GenericPropertyMatchers.ignoreCase())
//                .withMatcher(&quot;shopId&quot;, ExampleMatcher.GenericPropertyMatchers.exact());
//
//        Example&lt;ProductPo&gt; example = Example.of(queryExample, matcher);
//
//        Page&lt;ProductPo&gt; pos = this.productPoMapper.findAll(example, pageable);
//        ret = pos.stream().map(po -&gt; {
//            Long id = po.getId();
//            String key = String.format(KEY, id);
//            ValidOnSaleProductFactory factory = new ValidOnSaleProductFactory(id);
//            Product bo = factory.build(po, Optional.empty());
//            return bo;
//        }).collect(Collectors.toList());
//        return ret;
//    }

    /**
     * 根据店铺id、条形码和名称查找商品
     * 如果非空则通过 OpenFeign 查询后再通过数据库补全数据
     * @param shopId 商铺id 精确
     * @param barCode 条码 忽略大小写
     * @param name 商品名称 按照开头模糊查询
     * @param page 页码
     * @param pageSize 每页大小
     * @return 商品列表
     */
    public List&lt;Product&gt; retrieveByShopIdAndBarCodeAndName(Long shopId, String barCode, String name, Integer page, Integer pageSize) {
<span class="fc" id="L368">        List&lt;Product&gt; products = new ArrayList&lt;&gt;();</span>
        try {
            // 使用 Feign 调用搜索服务
            InternalReturnObject&lt;List&lt;Long&gt;&gt; ret;
<span class="pc bpc" id="L372" title="2 of 4 branches missed.">            if (StringUtils.isNoneBlank(barCode) &amp;&amp; shopId != null) {</span>
                // 调用按 name、barcode 和 shopId 组合查询
<span class="nc" id="L374">                ret = searchMapper.searchProductsByNameAndBarcodeAndShopId(name, barCode, shopId, page, pageSize);</span>
            } else {
                // 调用按 name 模糊查询
<span class="nc" id="L377">                ret = searchMapper.searchProductsByName(name, page, pageSize);</span>
            }

<span class="nc bnc" id="L380" title="All 2 branches missed.">            if (ReturnNo.OK.getErrNo() == ret.getErrno()) {</span>
<span class="nc" id="L381">                List&lt;Long&gt; ids = ret.getData();</span>
<span class="nc bnc" id="L382" title="All 4 branches missed.">                if (ids != null &amp;&amp; !ids.isEmpty()) {</span>
                    // 从数据库根据 ID 查询补全数据
<span class="nc" id="L384">                    List&lt;ProductPo&gt; productPos = productPoMapper.findAllById(ids);</span>
<span class="nc" id="L385">                    products = productPos.stream().map(po -&gt; {</span>
<span class="nc" id="L386">                        Long id = po.getId();</span>
<span class="nc" id="L387">                        ValidOnSaleProductFactory factory = new ValidOnSaleProductFactory(id);</span>
<span class="nc" id="L388">                        return factory.build(po, Optional.empty());</span>
<span class="nc" id="L389">                    }).collect(Collectors.toList());</span>
                }
<span class="nc" id="L391">            } else {</span>
<span class="nc" id="L392">                logger.debug(&quot;SearchMapper: searchProducts error {}&quot;, ReturnNo.getReturnNoByCode(ret.getErrno()));</span>
<span class="nc" id="L393">                throw new BusinessException(ReturnNo.getReturnNoByCode(ret.getErrno()), ret.getErrmsg());</span>
            }
<span class="fc" id="L395">        } catch (Exception e) {</span>
<span class="fc" id="L396">            logger.error(&quot;Error retrieving products: &quot;, e);</span>
<span class="fc" id="L397">            throw new BusinessException(ReturnNo.INTERNAL_SERVER_ERR, &quot;Error retrieving products&quot;);</span>
<span class="nc" id="L398">        }</span>
<span class="nc" id="L399">        return products;</span>
    }


    /**
     * 插入产品
     *
     * @param product
     * @param user
     * @return
     */
    public Product insert(Product product, UserDto user) {
<span class="nc" id="L411">        product.setGmtCreate(LocalDateTime.now());</span>
<span class="nc" id="L412">        product.setCreator(user);</span>
<span class="nc" id="L413">        ProductPo productPo = CloneFactory.copy(new ProductPo(), product);</span>
<span class="nc" id="L414">        productPo.setId(null);</span>
<span class="nc bnc" id="L415" title="All 2 branches missed.">        if (productPo.getFreeThreshold() == null) {</span>
<span class="nc" id="L416">            productPo.setFreeThreshold(Product.DEFAULT);</span>
        }
<span class="nc" id="L418">        ProductPo save = this.productPoMapper.save(productPo);</span>
<span class="nc" id="L419">        product.setId(save.getId());</span>
<span class="nc" id="L420">        return product;</span>
    }

    /**
     * 更新
     *
     * @param product
     * @param user
     * @return
     * @author wuzhicheng
     */
    public String save(Product product, UserDto user) {
<span class="fc" id="L432">        product.setModifier(user);</span>
<span class="fc" id="L433">        product.setGmtModified(LocalDateTime.now());</span>
<span class="fc" id="L434">        ProductPo productPo = CloneFactory.copy(new ProductPo(), product);</span>
<span class="pc bpc" id="L435" title="2 of 6 branches missed.">        if(null !=productPo.getFreeThreshold()&amp;&amp;productPo.getFreeThreshold()!=-1&amp;&amp;productPo.getFreeThreshold()&lt;0){</span>
<span class="nc" id="L436">            throw new BusinessException(ReturnNo.FIELD_NOTVALID, String.format(ReturnNo.FIELD_NOTVALID.getMessage(), &quot;Threshold&quot;));</span>
        }
<span class="pc bpc" id="L438" title="1 of 4 branches missed.">        if(null != productPo.getWeight()&amp;&amp;productPo.getWeight()&lt;0){</span>
<span class="nc" id="L439">            throw new BusinessException(ReturnNo.FIELD_NOTVALID, String.format(ReturnNo.FIELD_NOTVALID.getMessage(), &quot;Weight&quot;));</span>
        }
<span class="fc" id="L441">        ProductPo save = this.productPoMapper.save(productPo);</span>
<span class="pc bpc" id="L442" title="1 of 2 branches missed.">        if (IDNOTEXIST.equals(save.getId())) {</span>
<span class="nc" id="L443">            throw new BusinessException(ReturnNo.RESOURCE_ID_NOTEXIST, String.format(ReturnNo.RESOURCE_ID_NOTEXIST.getMessage(), &quot;商品&quot;, product.getId()));</span>
        }
<span class="fc" id="L445">        return String.format(KEY, product.getId());</span>
    }

    /**
     * 根据模板id查询product
     *
     * @param id 模板id
     * @param page
     * @param pageSize
     * @return
     */
    public List&lt;Product&gt; retrieveProductByTemplateId(Long shopId,Long id, Integer page, Integer pageSize) {
<span class="fc" id="L457">        Pageable pageable = PageRequest.of(page - 1, pageSize);</span>
<span class="fc" id="L458">        List&lt;ProductPo&gt; pos = this.productPoMapper.findByTemplateIdEquals(id,pageable);</span>
<span class="pc" id="L459">        return pos.stream().filter(po -&gt; po.getShopId().equals(shopId)).map(po -&gt; CloneFactory.copy(new Product(), po)).collect(Collectors.toList());</span>



    }

    /**
     * 根据物流渠道id查询product
     *
     * @param id 模板id
     * @param page
     * @param pageSize
     * @return
     */
    public List&lt;Product&gt; retrieveProductByLogisticsIdAndShopId(Long shopId,Long id, Integer page, Integer pageSize){
<span class="fc" id="L474">        Pageable pageable = PageRequest.of(page - 1, pageSize);</span>
<span class="fc" id="L475">        List&lt;ProductPo&gt; pos = productPoMapper.findByShopLogisticIdEquals(id, pageable);</span>
<span class="pc" id="L476">        return pos.stream().filter(po -&gt; po.getShopId().equals(shopId)).map(po -&gt; CloneFactory.copy(new Product(), po)).collect(Collectors.toList());</span>

    }


    /**
     * 根据分类查询product
     *
     * @param id 模板id
     * @param page
     * @param pageSize
     * @return
     */
    public List&lt;Product&gt; retrieveProductByCategory(Long id, Integer page, Integer pageSize){
<span class="fc" id="L490">        Pageable pageable = PageRequest.of(page - 1, pageSize);</span>
<span class="fc" id="L491">        List&lt;ProductPo&gt; pos = productPoMapper.findByCategoryIdEquals(id,pageable);</span>
<span class="pc bnc" id="L492" title="All 4 branches missed.">        return pos.stream().map(productPo -&gt; this.findValidById(productPo.getShopId(),productPo.getId())).filter(obj -&gt; null != obj &amp;&amp; obj.getStatus() == Product.OFFSHELF ).collect(Collectors.toList());</span>


    }

    /**
     * 因为管理员删除产品，将产品改为无分类的产品
     *
     * @param categoryId 商品类目Id
     * @param userDto    操作人
     * @return 影响的product的redis key
     */
    public List&lt;String&gt; changeToNoCategoryProduct(Long categoryId, UserDto userDto) throws RuntimeException {
<span class="nc" id="L505">        logger.debug(&quot;changeToNoCategoryProduct: categoryId = {}&quot;, categoryId);</span>

<span class="nc" id="L507">        List&lt;ProductPo&gt; pos = this.productPoMapper.findByCategoryIdEquals(categoryId, PageRequest.of(0, MAX_RETURN));</span>
<span class="nc" id="L508">        List&lt;String&gt; keyList = new ArrayList&lt;&gt;(pos.size());</span>
<span class="nc" id="L509">        LocalDateTime now = LocalDateTime.now();</span>
<span class="nc bnc" id="L510" title="All 2 branches missed.">        for (ProductPo po : pos){</span>
<span class="nc" id="L511">            ProductPo updateObj = new ProductPo();</span>
<span class="nc" id="L512">            updateObj.setId(po.getId());</span>
<span class="nc" id="L513">            updateObj.setCategoryId(Category.NOCATEGORY);</span>
<span class="nc" id="L514">            updateObj.setModifierId(userDto.getId());</span>
<span class="nc" id="L515">            updateObj.setGmtModified(now);</span>
<span class="nc" id="L516">            this.productPoMapper.save(updateObj);</span>
<span class="nc" id="L517">            keyList.add(String.format(KEY,po.getId()));</span>
<span class="nc" id="L518">        }</span>
<span class="nc" id="L519">        return keyList;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>