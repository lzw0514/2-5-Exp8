<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Product.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">product</a> &gt; <a href="index.source.html" class="el_package">cn.edu.xmu.oomall.product.dao.bo</a> &gt; <span class="el_source">Product.java</span></div><h1>Product.java</h1><pre class="source lang-java linenums">//School of Informatics Xiamen University, GPL-3.0 license
package cn.edu.xmu.oomall.product.dao.bo;

import cn.edu.xmu.javaee.core.aop.CopyFrom;
import cn.edu.xmu.javaee.core.exception.BusinessException;
import cn.edu.xmu.javaee.core.model.ReturnNo;
import cn.edu.xmu.javaee.core.model.bo.OOMallObject;
import cn.edu.xmu.oomall.product.controller.dto.ProductDto;
import cn.edu.xmu.oomall.product.dao.CategoryDao;
import cn.edu.xmu.oomall.product.dao.ProductDao;
import cn.edu.xmu.oomall.product.dao.onsale.OnSaleExecutor;
import cn.edu.xmu.oomall.product.dao.openfeign.FreightDao;
import cn.edu.xmu.oomall.product.dao.openfeign.ShopDao;
import cn.edu.xmu.oomall.product.dao.openfeign.TemplateDao;
import cn.edu.xmu.oomall.product.mapper.openfeign.po.Logistics;
import cn.edu.xmu.oomall.product.mapper.openfeign.po.Shop;
import cn.edu.xmu.oomall.product.mapper.openfeign.po.Template;
import cn.edu.xmu.oomall.product.mapper.po.ProductPo;
import com.fasterxml.jackson.annotation.JsonIgnore;
import com.fasterxml.jackson.annotation.JsonInclude;
import lombok.*;
import lombok.extern.slf4j.Slf4j;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.Serializable;
import java.time.LocalDateTime;
import java.util.*;

@NoArgsConstructor
@ToString(callSuper = true, doNotUseGetters = true)
@JsonInclude(JsonInclude.Include.NON_NULL)
@CopyFrom({ProductDraft.class, ProductDto.class, ProductPo.class})
<span class="fc" id="L34">@Slf4j</span>
public class Product extends OOMallObject implements Serializable {

    //无相关的商品
    @JsonIgnore
<span class="fc" id="L39">    public static final Long NO_RELATE_PRODUCT=0L;</span>

    //无相关的运费模板
    @JsonIgnore
<span class="fc" id="L43">    public static final Long NO_TEMPLATE=0L;</span>

    //使用默认的免邮门槛
    @JsonIgnore
<span class="fc" id="L47">    public static final Long DEFAULT=-1L;</span>


    /**
     * 共两种状态
     */
    //禁售中
    @JsonIgnore
<span class="fc" id="L55">    public static final  Byte BANNED = 0;</span>

    //上架
    @JsonIgnore
<span class="fc" id="L59">    public static final  Byte ONSHELF  = 1;</span>

    //下架
    @JsonIgnore
<span class="fc" id="L63">    public static final  Byte OFFSHELF  = 2;</span>

    //未禁售
    @JsonIgnore
<span class="fc" id="L67">    private static final  Byte ALLOW  = 3;</span>

    /**
     * 状态和名称的对应
     */
    @JsonIgnore
<span class="fc" id="L73">    public static final Map&lt;Byte, String&gt; STATUSNAMES = new HashMap(){</span>
        {
<span class="fc" id="L75">            put(ONSHELF, &quot;上架&quot;);</span>
<span class="fc" id="L76">            put(BANNED, &quot;禁售&quot;);</span>
<span class="fc" id="L77">            put(OFFSHELF, &quot;下架&quot;);</span>
<span class="fc" id="L78">        }</span>
    };
    /**
     * 获得当前状态名称
     * @author Ming Qiu
     * &lt;p&gt;
     * date: 2022-11-13 0:43
     * @return
     */
    @JsonIgnore
    public String getStatusName(){
<span class="nc" id="L89">        return STATUSNAMES.get(this.status);</span>
    }

    private String skuSn;

    private String name;

    private Long originalPrice;

    private Long weight;

    private String barcode;

    private String unit;

    private String originPlace;

    @Setter
    private Integer commissionRatio;

    public Integer getCommissionRatio(){
<span class="pc bpc" id="L110" title="1 of 4 branches missed.">        if (null == this.commissionRatio &amp;&amp; null != getCategory()){</span>
<span class="fc" id="L111">            this.commissionRatio = this.getCategory().getCommissionRatio();</span>
        }
<span class="fc" id="L113">        return this.commissionRatio;</span>
    }

    private Byte status;

    public void setStatus(Byte status){
<span class="fc" id="L119">        this.status = status;</span>
<span class="fc" id="L120">    }</span>

    /**
     * 获得商品状态
     * @return
     */
    public Byte getStatus() {
<span class="fc" id="L127">        log.debug(&quot;getStatus: id ={}&quot;,this.id);</span>
<span class="fc" id="L128">        LocalDateTime now = LocalDateTime.now();</span>
<span class="fc bfc" id="L129" title="All 2 branches covered.">        if(this.status == null )return null;</span>
<span class="pc bpc" id="L130" title="1 of 2 branches missed.">        if ((this.status.equals(Product.BANNED))) {</span>
<span class="nc" id="L131">            return Product.BANNED;</span>
        }else{
<span class="pc bpc" id="L133" title="1 of 2 branches missed.">            if (null == this.getValidOnsale()){</span>
<span class="nc" id="L134">                return Product.OFFSHELF;</span>
            }else{
<span class="pc bpc" id="L136" title="2 of 4 branches missed.">                if (this.getValidOnsale().getBeginTime().isBefore(now) &amp;&amp; this.getValidOnsale().getEndTime().isAfter(now)) {</span>
<span class="fc" id="L137">                    return Product.ONSHELF;</span>
                }else{
<span class="nc" id="L139">                    return Product.OFFSHELF;</span>
                }
            }
        }
    }

    private Long goodsId;
    /**
     * 相关商品
     */
    @JsonIgnore
    @ToString.Exclude
    private List&lt;Product&gt; otherProduct;

    @Setter
    @JsonIgnore
    @ToString.Exclude
    private ProductDao productDao;
    /**
     * @author jyx
     */
    @JsonIgnore
    public List&lt;Product&gt; getOtherProduct(){
<span class="pc bpc" id="L162" title="2 of 4 branches missed.">        if (null == this.otherProduct&amp;&amp; null != this.productDao){</span>
<span class="fc" id="L163">            this.otherProduct = this.productDao.retrieveOtherProductById(this.shopId, this.goodsId);</span>
        }
<span class="fc" id="L165">        return this.otherProduct;</span>
    }
    /**
     * 有效上架， 包括即将上架
     */
    @JsonIgnore
    @ToString.Exclude
    private OnSale validOnsale;

    @Setter
    @JsonIgnore
    @ToString.Exclude
    private OnSaleExecutor onsaleExecutor;

    /**
     * 采用command模式获取不同的onsale
     *
     * @author Ming Qiu
     * &lt;p&gt;
     * date: 2022-12-04 19:21
     * @return
     */
    public OnSale getValidOnsale(){
<span class="pc bpc" id="L188" title="1 of 4 branches missed.">        if (Objects.isNull(this.validOnsale) &amp;&amp; Objects.nonNull(this.onsaleExecutor)){</span>
<span class="fc" id="L189">            log.debug(&quot;getValidOnsale: onsaleExecutor = {}&quot;, this.onsaleExecutor);</span>
<span class="fc" id="L190">            this.validOnsale = this.onsaleExecutor.execute();</span>
        }

<span class="fc" id="L193">        log.debug(&quot;getValidOnsale: validOnsale = {}&quot;, this.validOnsale);</span>
<span class="pc bpc" id="L194" title="2 of 4 branches missed.">        if (Objects.isNull(this.validOnsale) || this.validOnsale.getId().equals(OnSale.NOTEXIST)){</span>
<span class="nc" id="L195">            return null;</span>
        }
<span class="fc" id="L197">        return this.validOnsale;</span>
    }

    @JsonIgnore
    public Long getPrice() {
<span class="pc bpc" id="L202" title="1 of 2 branches missed.">        if (Objects.nonNull(this.getValidOnsale())) {</span>
<span class="fc" id="L203">            return this.validOnsale.getPrice();</span>
        } else {
<span class="nc" id="L205">            return null;</span>
        }
    }

    @JsonIgnore
    public Integer getQuantity() {
<span class="pc bpc" id="L211" title="1 of 2 branches missed.">        if (Objects.nonNull(this.getValidOnsale())) {</span>
<span class="fc" id="L212">            return this.validOnsale.getQuantity();</span>
        } else {
<span class="nc" id="L214">            return null;</span>
        }
    }

    @JsonIgnore
    public LocalDateTime getBeginTime() {
<span class="pc bpc" id="L220" title="1 of 2 branches missed.">        if (Objects.nonNull(this.getValidOnsale())) {</span>
<span class="fc" id="L221">            return this.validOnsale.getBeginTime();</span>
        } else {
<span class="nc" id="L223">            return null;</span>
        }
    }

    @JsonIgnore
    public LocalDateTime getEndTime() {
<span class="pc bpc" id="L229" title="1 of 2 branches missed.">        if (Objects.nonNull(this.getValidOnsale())) {</span>
<span class="fc" id="L230">            return this.validOnsale.getEndTime();</span>
        } else {
<span class="nc" id="L232">            return null;</span>
        }
    }

    @JsonIgnore
    public Integer getMaxQuantity() {
<span class="pc bpc" id="L238" title="1 of 2 branches missed.">        if (Objects.nonNull(this.getValidOnsale())) {</span>
<span class="fc" id="L239">            return this.validOnsale.getMaxQuantity();</span>
        } else {
<span class="nc" id="L241">            return null;</span>
        }
    }

    private Long categoryId;
    /**
     * 所属分类
     */
    @JsonIgnore
    @Setter
    @ToString.Exclude
    private Category category;

    @Setter
    @JsonIgnore
    @ToString.Exclude
    private CategoryDao categoryDao;
    /**
     * @author jyx
     */
    @JsonIgnore
    public Category getCategory(){
<span class="fc bfc" id="L263" title="All 2 branches covered.">        if (Objects.isNull(this.categoryId)){</span>
<span class="fc" id="L264">            return null;</span>
        }

<span class="pc bpc" id="L267" title="1 of 4 branches missed.">        if (Objects.isNull(this.category) &amp;&amp; Objects.nonNull(this.categoryDao)){</span>
<span class="fc" id="L268">            this.category = this.categoryDao.findById(this.categoryId);</span>
        }
<span class="fc" id="L270">        return this.category;</span>
    }

    @JsonIgnore
    public List&lt;Activity&gt; getActList(){
<span class="pc bpc" id="L275" title="1 of 2 branches missed.">        if (Objects.nonNull(this.getValidOnsale())) {</span>
<span class="fc" id="L276">            return this.getValidOnsale().getActList();</span>
        }
<span class="nc" id="L278">        return new ArrayList&lt;&gt;();</span>
    }

    private Long shopId;

    @JsonIgnore
    @ToString.Exclude
    private Shop shop;

    @JsonIgnore
    @ToString.Exclude
    @Setter
    private ShopDao shopDao;
    /**
     * @author jyx
     */
    @JsonIgnore
    public Shop getShop(){
<span class="pc bpc" id="L296" title="1 of 2 branches missed.">        if (Objects.isNull(this.shopId)){</span>
<span class="nc" id="L297">            throw new BusinessException(ReturnNo.INCONSISTENT_DATA, String.format(ReturnNo.INCONSISTENT_DATA.getMessage(), &quot;产品&quot;, this.id, &quot;shopId为空&quot;));</span>
        }

<span class="pc bpc" id="L300" title="1 of 4 branches missed.">        if (Objects.isNull(this.shop) &amp;&amp; Objects.nonNull(this.shopDao)){</span>
<span class="fc" id="L301">            this.shop = this.shopDao.findById(this.shopId);</span>
        }
<span class="fc" id="L303">        return this.shop;</span>
    }
    /**
     *@author jyx
     */
    @JsonIgnore
    @ToString.Exclude
    private Logistics logistics;
    /**
     *@author jyx
     */
    @JsonIgnore
    @ToString.Exclude
    @Setter
    private FreightDao freightDao;

    @JsonIgnore
    public Logistics getLogistics(){
<span class="pc bpc" id="L321" title="1 of 2 branches missed.">        if(Objects.isNull(this.shopId)){</span>
<span class="nc" id="L322">            throw new BusinessException(ReturnNo.INCONSISTENT_DATA, String.format(ReturnNo.INCONSISTENT_DATA.getMessage(), &quot;产品&quot;, this.id, &quot;shopId为空&quot;));</span>
<span class="pc bpc" id="L323" title="1 of 2 branches missed.">        } else if (Objects.isNull(this.shopLogisticId)) {</span>
<span class="fc" id="L324">            return null;</span>
        }
<span class="nc bnc" id="L326" title="All 4 branches missed.">        if (Objects.isNull(this.logistics) &amp;&amp; Objects.nonNull(this.freightDao)){</span>
            try {
<span class="nc" id="L328">                this.logistics = this.freightDao.GetLogistics(this.shopId,this.shopLogisticId);</span>
<span class="nc" id="L329">            } catch (BusinessException e) {</span>
<span class="nc bnc" id="L330" title="All 2 branches missed.">                if (ReturnNo.RESOURCE_ID_NOTEXIST == e.getErrno()) {</span>
<span class="nc" id="L331">                    throw new BusinessException(ReturnNo.INCONSISTENT_DATA, String.format(ReturnNo.INCONSISTENT_DATA.getMessage(), &quot;产品&quot;, this.id, &quot;shopLogisticId无法找到对应物流渠道&quot;));</span>
                }
<span class="nc" id="L333">            }</span>
        }
<span class="nc" id="L335">        return this.logistics;</span>
    }

    private Long templateId;

    @JsonIgnore
    @ToString.Exclude
    private Template template;

    @JsonIgnore
    @ToString.Exclude
    @Setter
    private TemplateDao templateDao;
    /**
     *@author jyx
     */
    @JsonIgnore
    public Template getTemplate() {
<span class="pc bpc" id="L353" title="1 of 2 branches missed.">        if (Objects.isNull(this.shopId)){</span>
<span class="nc" id="L354">            throw new BusinessException(ReturnNo.INCONSISTENT_DATA, String.format(ReturnNo.INCONSISTENT_DATA.getMessage(), &quot;产品&quot;, this.id, &quot;shopId为空&quot;));</span>
        }
<span class="pc bpc" id="L356" title="1 of 2 branches missed.">        if (Objects.isNull(this.templateId)){</span>
<span class="nc" id="L357">            throw new BusinessException(ReturnNo.INCONSISTENT_DATA, String.format(ReturnNo.INCONSISTENT_DATA.getMessage(), &quot;产品&quot;, this.id, &quot;templateId为空&quot;));</span>
        }
<span class="pc bpc" id="L359" title="1 of 4 branches missed.">        if (Objects.isNull(this.template) &amp;&amp; Objects.nonNull(this.templateDao)){</span>
<span class="fc" id="L360">            this.template = this.templateDao.findById(this.shopId, this.templateId);</span>
        }
<span class="fc" id="L362">        return this.template;</span>
    }

    private Long shopLogisticId;



    private Long freeThreshold;

    public void ban(){
<span class="nc bnc" id="L372" title="All 2 branches missed.">        if(this.status.equals(BANNED)){</span>
<span class="nc" id="L373">            throw new BusinessException(ReturnNo.STATENOTALLOW,String.format(ReturnNo.STATENOTALLOW.getMessage(),&quot;BANNED&quot;,this.id));</span>
        }
<span class="nc" id="L375">        this.status = BANNED;</span>
<span class="nc" id="L376">    }</span>

    public void allow(){
<span class="nc bnc" id="L379" title="All 2 branches missed.">        if(this.status.equals(ALLOW)){</span>
<span class="nc" id="L380">            throw new BusinessException(ReturnNo.STATENOTALLOW,String.format(ReturnNo.STATENOTALLOW.getMessage(),&quot;ALLOW&quot;,this.id));</span>
        }
<span class="nc" id="L382">        this.status = ALLOW;</span>
<span class="nc" id="L383">    }</span>

    public Long getId() {
<span class="fc" id="L386">        return id;</span>
    }

    public void setId(Long id) {
<span class="fc" id="L390">        this.id = id;</span>
<span class="fc" id="L391">    }</span>

    public Long getCreatorId() {
<span class="fc" id="L394">        return creatorId;</span>
    }

    public void setCreatorId(Long creatorId) {
<span class="fc" id="L398">        this.creatorId = creatorId;</span>
<span class="fc" id="L399">    }</span>

    public String getCreatorName() {
<span class="fc" id="L402">        return creatorName;</span>
    }

    public void setCreatorName(String creatorName) {
<span class="fc" id="L406">        this.creatorName = creatorName;</span>
<span class="fc" id="L407">    }</span>

    public Long getModifierId() {
<span class="fc" id="L410">        return modifierId;</span>
    }

    public void setModifierId(Long modifierId) {
<span class="fc" id="L414">        this.modifierId = modifierId;</span>
<span class="fc" id="L415">    }</span>

    public String getModifierName() {
<span class="fc" id="L418">        return modifierName;</span>
    }

    public void setModifierName(String modifierName) {
<span class="fc" id="L422">        this.modifierName = modifierName;</span>
<span class="fc" id="L423">    }</span>

    public LocalDateTime getGmtCreate() {
<span class="fc" id="L426">        return gmtCreate;</span>
    }

    public void setGmtCreate(LocalDateTime gmtCreate) {
<span class="fc" id="L430">        this.gmtCreate = gmtCreate;</span>
<span class="fc" id="L431">    }</span>

    public LocalDateTime getGmtModified() {
<span class="fc" id="L434">        return gmtModified;</span>
    }

    public void setGmtModified(LocalDateTime gmtModified) {
<span class="fc" id="L438">        this.gmtModified = gmtModified;</span>
<span class="fc" id="L439">    }</span>

    public String getSkuSn() {
<span class="fc" id="L442">        return skuSn;</span>
    }

    public void setSkuSn(String skuSn) {
<span class="fc" id="L446">        this.skuSn = skuSn;</span>
<span class="fc" id="L447">    }</span>

    public String getName() {
<span class="fc" id="L450">        return name;</span>
    }

    public void setName(String name) {
<span class="fc" id="L454">        this.name = name;</span>
<span class="fc" id="L455">    }</span>

    public Long getOriginalPrice() {
<span class="fc" id="L458">        return originalPrice;</span>
    }

    public void setOriginalPrice(Long originalPrice) {
<span class="fc" id="L462">        this.originalPrice = originalPrice;</span>
<span class="fc" id="L463">    }</span>

    public Long getWeight() {
<span class="fc" id="L466">        return weight;</span>
    }

    public void setWeight(Long weight) {
<span class="fc" id="L470">        this.weight = weight;</span>
<span class="fc" id="L471">    }</span>

    public String getBarcode() {
<span class="fc" id="L474">        return barcode;</span>
    }

    public void setBarcode(String barcode) {
<span class="fc" id="L478">        this.barcode = barcode;</span>
<span class="fc" id="L479">    }</span>

    public String getUnit() {
<span class="fc" id="L482">        return unit;</span>
    }

    public void setUnit(String unit) {
<span class="fc" id="L486">        this.unit = unit;</span>
<span class="fc" id="L487">    }</span>

    public String getOriginPlace() {
<span class="fc" id="L490">        return originPlace;</span>
    }

    public void setOriginPlace(String originPlace) {
<span class="fc" id="L494">        this.originPlace = originPlace;</span>
<span class="fc" id="L495">    }</span>

    public Long getShopLogisticId() {
<span class="fc" id="L498">        return shopLogisticId;</span>
    }

    public void setShopLogisticId(Long shopLogisticId) {
<span class="fc" id="L502">        this.shopLogisticId = shopLogisticId;</span>
<span class="fc" id="L503">    }</span>

    public Long getGoodsId() {
<span class="fc" id="L506">        return goodsId;</span>
    }

    public void setGoodsId(Long goodsId) {
<span class="fc" id="L510">        this.goodsId = goodsId;</span>
<span class="fc" id="L511">    }</span>

    public Long getCategoryId() {
<span class="fc" id="L514">        return categoryId;</span>
    }

    public void setCategoryId(Long categoryId) {
<span class="fc" id="L518">        this.categoryId = categoryId;</span>
<span class="fc" id="L519">    }</span>

    public Long getShopId() {
<span class="fc" id="L522">        return shopId;</span>
    }

    public void setShopId(Long shopId) {
<span class="fc" id="L526">        this.shopId = shopId;</span>
<span class="fc" id="L527">    }</span>

    public Long getTemplateId() {
<span class="fc" id="L530">        return templateId;</span>
    }

    public void setTemplateId(Long templateId) {
<span class="fc" id="L534">        this.templateId = templateId;</span>
<span class="fc" id="L535">    }</span>

    public Long getFreeThreshold() {
<span class="fc" id="L538">        return freeThreshold;</span>
    }

    public void setFreeThreshold(Long freeThreshold) {
<span class="fc" id="L542">        this.freeThreshold = freeThreshold;</span>
<span class="fc" id="L543">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>