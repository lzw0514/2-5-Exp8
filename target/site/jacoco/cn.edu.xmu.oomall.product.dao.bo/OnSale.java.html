<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>OnSale.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">product</a> &gt; <a href="index.source.html" class="el_package">cn.edu.xmu.oomall.product.dao.bo</a> &gt; <span class="el_source">OnSale.java</span></div><h1>OnSale.java</h1><pre class="source lang-java linenums">//School of Informatics Xiamen University, GPL-3.0 license

package cn.edu.xmu.oomall.product.dao.bo;

import cn.edu.xmu.javaee.core.aop.CopyFrom;
import cn.edu.xmu.javaee.core.model.bo.OOMallObject;
import cn.edu.xmu.javaee.core.model.dto.UserDto;
import cn.edu.xmu.oomall.product.controller.dto.GrouponActDto;
import cn.edu.xmu.oomall.product.controller.dto.OnSaleDto;
import cn.edu.xmu.oomall.product.dao.ProductDao;
import cn.edu.xmu.oomall.product.dao.activity.ActivityDao;
import cn.edu.xmu.oomall.product.dao.onsale.OnSaleDao;
import cn.edu.xmu.oomall.product.dao.openfeign.ShopDao;
import cn.edu.xmu.oomall.product.mapper.openfeign.po.Shop;
import cn.edu.xmu.oomall.product.mapper.po.OnsalePo;
import com.fasterxml.jackson.annotation.JsonIgnore;
import com.fasterxml.jackson.annotation.JsonInclude;
import lombok.Builder;
import lombok.NoArgsConstructor;
import lombok.Setter;
import lombok.ToString;
import lombok.extern.slf4j.Slf4j;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.Serializable;
import java.time.LocalDateTime;
import java.util.List;
import java.util.Objects;

@NoArgsConstructor
@ToString(callSuper = true, doNotUseGetters = true)
@JsonInclude(JsonInclude.Include.NON_NULL)
@CopyFrom({OnsalePo.class, OnSaleDto.class, GrouponActDto.class})
<span class="fc" id="L35">@Slf4j</span>
public class OnSale extends OOMallObject implements Serializable {
    @JsonIgnore
<span class="fc" id="L38">    public  final static Long NOTEXIST = -1L;</span>

    @Builder
    public OnSale(Long id, Long creatorId, String creatorName, Long modifierId, String modifierName, LocalDateTime gmtCreate, LocalDateTime gmtModified, Long price, LocalDateTime beginTime, LocalDateTime endTime, Integer quantity, Integer maxQuantity, Long shopId, Long productId, Byte type, Long deposit, LocalDateTime payTime) {
<span class="fc" id="L42">        super(id, creatorId, creatorName, modifierId, modifierName, gmtCreate, gmtModified);</span>
<span class="fc" id="L43">        this.price = price;</span>
<span class="fc" id="L44">        this.beginTime = beginTime;</span>
<span class="fc" id="L45">        this.endTime = endTime;</span>
<span class="fc" id="L46">        this.quantity = quantity;</span>
<span class="fc" id="L47">        this.maxQuantity = maxQuantity;</span>
<span class="fc" id="L48">        this.shopId = shopId;</span>
<span class="fc" id="L49">        this.productId = productId;</span>
<span class="fc" id="L50">        this.type = type;</span>
<span class="fc" id="L51">        this.deposit = deposit;</span>
<span class="fc" id="L52">        this.payTime = payTime;</span>
<span class="fc" id="L53">    }</span>

    /**
     * 正常
     */
    @JsonIgnore
<span class="fc" id="L59">    public static final Byte NORMAL = 0;</span>
    /**
     * 秒杀
     */
    @JsonIgnore
<span class="fc" id="L64">    public static final Byte SECONDKILL = 1;</span>

    /**
     * 预售
     */
    @JsonIgnore
<span class="fc" id="L70">    public static final Byte GROUPON = 2;</span>

    /**
     * 预售
     */
    @JsonIgnore
<span class="fc" id="L76">    public static final Byte ADVSALE = 3;</span>


    private Long price;

    public Long getPrice() {
<span class="fc" id="L82">        return price;</span>
    }

    public void setPrice(Long price) {
<span class="fc" id="L86">        this.price = price;</span>
<span class="fc" id="L87">    }</span>

    private LocalDateTime beginTime;

    public LocalDateTime getBeginTime() {
<span class="fc" id="L92">        return beginTime;</span>
    }

    public void setBeginTime(LocalDateTime beginTime) {
<span class="fc" id="L96">        this.beginTime = beginTime;</span>
<span class="fc" id="L97">    }</span>

    private LocalDateTime endTime;

    public LocalDateTime getEndTime() {
<span class="fc" id="L102">        return endTime;</span>
    }

    public void setEndTime(LocalDateTime endTime) {
<span class="fc" id="L106">        this.endTime = endTime;</span>
<span class="fc" id="L107">    }</span>

    private Integer quantity;

    public Integer getQuantity() {
<span class="fc" id="L112">        return quantity;</span>
    }

    public void setQuantity(Integer quantity) {
<span class="fc" id="L116">        this.quantity = quantity;</span>
<span class="fc" id="L117">    }</span>


    private Integer maxQuantity;

    public Integer getMaxQuantity() {
<span class="fc" id="L123">        return maxQuantity;</span>
    }

    public void setMaxQuantity(Integer maxQuantity) {
<span class="fc" id="L127">        this.maxQuantity = maxQuantity;</span>
<span class="fc" id="L128">    }</span>


    private Long shopId;

    public Long getShopId() {
<span class="fc" id="L134">        return shopId;</span>
    }

    public void setShopId(Long shopId) {
<span class="fc" id="L138">        this.shopId = shopId;</span>
<span class="fc" id="L139">    }</span>

    @Setter
    @JsonIgnore
    @ToString.Exclude
    private ShopDao shopDao;

    @JsonIgnore
    @ToString.Exclude
    private Shop shop;

    /**
     * @modify Rui Li
     * @task 2023-dgn2-007
     */
    public Shop getShop() {
<span class="pc bpc" id="L155" title="1 of 2 branches missed.">        if (null == this.shopId){</span>
<span class="nc" id="L156">            return null;</span>
        }
<span class="pc bpc" id="L158" title="2 of 4 branches missed.">        if (null == this.shop &amp;&amp; null != this.shopDao){</span>
<span class="fc" id="L159">            this.shop = this.shopDao.findById(this.shopId);</span>
        }
<span class="fc" id="L161">        return this.shop;</span>
    }

    private Long productId;

    public Long getProductId() {
<span class="fc" id="L167">        return productId;</span>
    }

    public void setProductId(Long productId) {
<span class="fc" id="L171">        this.productId = productId;</span>
<span class="fc" id="L172">    }</span>

    @Setter
    @JsonIgnore
    @ToString.Exclude
    private ProductDao productDao;

    @JsonIgnore
    @ToString.Exclude
    private Product product;

    public Product getProduct() {
<span class="pc bpc" id="L184" title="2 of 4 branches missed.">        if (null == this.product &amp;&amp; null != this.productDao) {</span>
<span class="fc" id="L185">            this.product = this.productDao.findValidById(this.shopId, this.productId);</span>
        }
<span class="fc" id="L187">        return this.product;</span>
    }


    @JsonIgnore
    @ToString.Exclude
    private List&lt;Activity&gt; actList;

    @Setter
    @JsonIgnore
    @ToString.Exclude
    private ActivityDao activityDao;

    public List&lt;Activity&gt; getActList() {
<span class="pc bpc" id="L201" title="1 of 4 branches missed.">        if (Objects.isNull(this.actList) &amp;&amp; Objects.nonNull(this.activityDao)) {</span>
<span class="fc" id="L202">            this.actList = this.activityDao.retrieveByOnsaleId(this.id);</span>
<span class="fc" id="L203">            log.debug(&quot;getActList: actList = {}&quot;, actList);</span>
        }
<span class="fc" id="L205">        log.debug(&quot;getActList: actList = {}&quot;, this.actList);</span>
<span class="fc" id="L206">        return this.actList;</span>

    }

    @ToString.Exclude
    @JsonIgnore
    @Setter
    private OnSaleDao onSaleDao;

    /**
     * @modify Rui Li
     * @task 2023-dgn2-007
     * 取消销售
     * @param cancelTime 取消时间
     * @return 取消销售需修改的属性
     */
    public String cancel(LocalDateTime cancelTime, UserDto user){
<span class="fc" id="L223">        OnSale updateOnsale = OnSale.builder().id(this.id).build();</span>

<span class="fc bfc" id="L225" title="All 2 branches covered.">        if(this.getBeginTime().isAfter(cancelTime)){</span>
            //销售活动未开始
<span class="fc" id="L227">            updateOnsale.setEndTime(this.getBeginTime());</span>
<span class="fc bfc" id="L228" title="All 2 branches covered.">        }else if (this.getEndTime().isBefore(cancelTime)) {</span>
            //销售活动已结束
<span class="fc" id="L230">            updateOnsale.setEndTime(this.getEndTime());</span>
        } else{
            //销售活动正在进行中
<span class="fc" id="L233">            updateOnsale.setEndTime(cancelTime);</span>
        }
<span class="fc" id="L235">        return this.onSaleDao.save(updateOnsale, user);</span>
    }

    public Boolean hasValue(){
<span class="pc bpc" id="L239" title="8 of 10 branches missed.">        return (Objects.nonNull(this.productId) || Objects.nonNull(this.beginTime) || Objects.nonNull( this.endTime) || Objects.nonNull(this.price) || Objects.nonNull(this.shopId) ||</span>
<span class="pc bnc" id="L240" title="All 10 branches missed.">                Objects.nonNull(this.quantity) || Objects.nonNull(this.maxQuantity) || Objects.nonNull(this.deposit) || Objects.nonNull(this.payTime) || Objects.nonNull(this.type));</span>
    }

    private Byte type;

    public Byte getType() {
<span class="fc" id="L246">        return this.type;</span>
    }

    public void setType(Byte type) {
<span class="fc" id="L250">        this.type = type;</span>
<span class="fc" id="L251">    }</span>

    private Long deposit;

    public Long getDeposit() {
<span class="fc" id="L256">        return deposit;</span>
    }

    public void setDeposit(Long deposit) {
<span class="fc" id="L260">        this.deposit = deposit;</span>
<span class="fc" id="L261">    }</span>

    private LocalDateTime payTime;

    public LocalDateTime getPayTime() {
<span class="fc" id="L266">        return payTime;</span>
    }

    public void setPayTime(LocalDateTime payTime) {
<span class="fc" id="L270">        this.payTime = payTime;</span>
<span class="fc" id="L271">    }</span>


    public Long getId() {
<span class="fc" id="L275">        return id;</span>
    }

    public void setId(Long id) {
<span class="fc" id="L279">        this.id = id;</span>
<span class="fc" id="L280">    }</span>

    public Long getCreatorId() {
<span class="fc" id="L283">        return creatorId;</span>
    }

    public void setCreatorId(Long creatorId) {
<span class="fc" id="L287">        this.creatorId = creatorId;</span>
<span class="fc" id="L288">    }</span>

    public String getCreatorName() {
<span class="fc" id="L291">        return creatorName;</span>
    }

    public void setCreatorName(String creatorName) {
<span class="fc" id="L295">        this.creatorName = creatorName;</span>
<span class="fc" id="L296">    }</span>

    public Long getModifierId() {
<span class="fc" id="L299">        return modifierId;</span>
    }

    public void setModifierId(Long modifierId) {
<span class="fc" id="L303">        this.modifierId = modifierId;</span>
<span class="fc" id="L304">    }</span>

    public String getModifierName() {
<span class="fc" id="L307">        return modifierName;</span>
    }

    public void setModifierName(String modifierName) {
<span class="fc" id="L311">        this.modifierName = modifierName;</span>
<span class="fc" id="L312">    }</span>

    public LocalDateTime getGmtCreate() {
<span class="fc" id="L315">        return gmtCreate;</span>
    }

    public void setGmtCreate(LocalDateTime gmtCreate) {
<span class="fc" id="L319">        this.gmtCreate = gmtCreate;</span>
<span class="fc" id="L320">    }</span>

    public LocalDateTime getGmtModified() {
<span class="fc" id="L323">        return gmtModified;</span>
    }

    public void setGmtModified(LocalDateTime gmtModified) {
<span class="fc" id="L327">        this.gmtModified = gmtModified;</span>
<span class="fc" id="L328">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>