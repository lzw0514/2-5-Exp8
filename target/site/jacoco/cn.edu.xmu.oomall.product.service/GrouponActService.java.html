<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GrouponActService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">product</a> &gt; <a href="index.source.html" class="el_package">cn.edu.xmu.oomall.product.service</a> &gt; <span class="el_source">GrouponActService.java</span></div><h1>GrouponActService.java</h1><pre class="source lang-java linenums">//School of Informatics Xiamen University, GPL-3.0 license
package cn.edu.xmu.oomall.product.service;

import cn.edu.xmu.javaee.core.model.dto.UserDto;
import cn.edu.xmu.javaee.core.mapper.RedisUtil;
import cn.edu.xmu.oomall.product.dao.ProductDao;
import cn.edu.xmu.oomall.product.dao.onsale.OnSaleDao;
import cn.edu.xmu.oomall.product.dao.activity.ActivityDao;
import cn.edu.xmu.oomall.product.dao.bo.*;
import lombok.RequiredArgsConstructor;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Propagation;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;
import java.util.List;
import java.util.Objects;
import java.util.stream.Collectors;

import static cn.edu.xmu.javaee.core.model.Constants.PLATFORM;

@Service
@Transactional(propagation = Propagation.REQUIRED)
@RequiredArgsConstructor
public class GrouponActService {

<span class="fc" id="L30">    private static Logger logger = LoggerFactory.getLogger(GrouponActService.class);</span>

    private final RedisUtil redisUtil;
    private final ProductDao productDao;
    private final OnSaleDao onsaleDao;
    private final ActivityDao activityDao;

    /**
     * 查询团购活动(上线状态)
     *
     * @param shopId    商铺Id
     * @param productId 商品Id
     * @param page      页码
     * @param pageSize  页大小
     * @return
     */
    public List&lt;GrouponAct&gt; retrieveValidByShopIdAndProductId(Long shopId, Long productId, LocalDateTime beginTime, LocalDateTime endTime, Integer page, Integer pageSize) {
<span class="fc" id="L47">        return this.activityDao.retrieveValidByShopIdAndProductId(shopId, productId, GrouponAct.ACTCLASS, beginTime, endTime, page, pageSize);</span>
    }

    /**
     * 查看团购详情
     *
     * @param shopId
     * @param id
     * @return
     */
    /**
     * 商户查询特定商铺所有团购活动
     *
     * @param shopId    商铺id
     * @param productId 货品id
     * @param status 状态
     * @param page      页码
     * @param pageSize  每页数目
     * @return 符合条件的预售活动
     */
    public List&lt;GrouponAct&gt; retrieveByShopId(Long shopId, Long productId, Integer status, Integer page,
                                             Integer pageSize) {
<span class="fc" id="L69">        return this.activityDao.retrieveByShopIdAndProductId(shopId, productId, GrouponAct.ACTCLASS, status, page, pageSize);</span>
    }

    public GrouponAct findByShopIdAndActId(Long shopId, Long id) {
<span class="fc" id="L73">        return this.activityDao.findById(id, shopId, GrouponAct.ACTCLASS);</span>
    }

    /**
     * 新增团购活动
     *
     * @param act 团购活动
     * @param onsale 团购对应的销售
     * @param user 操作者
     * @return
     */
    public GrouponAct createGrouponAct(GrouponAct act, OnSale onsale, UserDto user) {
<span class="fc" id="L85">        this.productDao.findNoOnsaleById(onsale.getShopId(), onsale.getProductId());</span>
<span class="fc" id="L86">        OnSale newOnsale = this.onsaleDao.insert(onsale, user);</span>
<span class="fc" id="L87">        GrouponAct newAct = this.activityDao.insert(act, user);</span>
<span class="fc" id="L88">        this.activityDao.insertActivityOnsale(newAct.getId(), newOnsale.getId(), user);</span>
<span class="fc" id="L89">        act.setId(newAct.getId());</span>
<span class="fc" id="L90">        return act;</span>
    }

    /**
     * 将商品增加到团购活动中
     *
     * @param actId 团购活动Id
     * @param onsale 团购对应的销售
     * @param user 操作者
     * @return
     */
    public GrouponAct addToGrouponAct(Long actId, OnSale onsale, UserDto user) {
<span class="fc" id="L102">        GrouponAct act = this.activityDao.findById(actId, onsale.getShopId(), GrouponAct.ACTCLASS);</span>
<span class="fc" id="L103">        this.productDao.findNoOnsaleById(onsale.getShopId(), onsale.getProductId());</span>
<span class="fc" id="L104">        OnSale newOnsale = act.addOnsaleOnAct(onsale, user);    // 向一个活动插入一个新的销售</span>
<span class="fc" id="L105">        this.activityDao.insertActivityOnsale(actId, newOnsale.getId(), user);</span>
<span class="fc" id="L106">        return act;</span>
    }

    /**
     * 修改团购信息
     *
     * @param act 团购活动
     * @param onsale 团购对应的销售
     * @param user 操作者
     * @return
     */
    public void updateGroupon(GrouponAct act, OnSale onsale, UserDto user) {
<span class="fc" id="L118">        GrouponAct oldAct = this.activityDao.findById(act.getId(), act.getShopId(), GrouponAct.ACTCLASS);</span>
<span class="pc bpc" id="L119" title="1 of 2 branches missed.">        if (onsale.hasValue()) {</span>
<span class="fc" id="L120">            List&lt;OnSale&gt; onsales = oldAct.getOnsaleList();</span>
<span class="pc bpc" id="L121" title="1 of 2 branches missed.">            if (Objects.isNull(onsale.getEndTime())) onsale.setEndTime(onsales.get(0).getEndTime());</span>
<span class="pc bpc" id="L122" title="1 of 2 branches missed.">            if (Objects.isNull(onsale.getBeginTime())) onsale.setBeginTime(onsales.get(0).getBeginTime());</span>
<span class="fc bfc" id="L123" title="All 2 branches covered.">            for (OnSale obj : onsales) {</span>
                //修改所有对象的beginTime和EndTime
<span class="fc" id="L125">                onsale.setId(obj.getId());</span>
<span class="fc" id="L126">                this.onsaleDao.save(onsale, user);</span>
<span class="fc" id="L127">            }</span>
        }
<span class="fc" id="L129">        act.setObjectId(oldAct.getObjectId()); // 会更新mongo，因此需要设置mongo_id</span>
<span class="fc" id="L130">        String key = this.activityDao.save(act, user);</span>
<span class="fc" id="L131">        this.redisUtil.del(key);</span>
<span class="fc" id="L132">    }</span>

    /**
     * 将商品从团购活动中移除
     * @param shopId    shop id
     * @param id        activity id
     * @param pid       product id
     * @param user
     *
     * @author WuTong
     * @task 2023-dgn2-008
     */
    public void cancelFromGrouponAct(Long shopId, Long id, Long pid, UserDto user) {
        // 判断活动是否合法
<span class="fc" id="L146">        this.activityDao.findById(id, shopId, GrouponAct.ACTCLASS);</span>
<span class="fc" id="L147">        OnSale onsale = this.onsaleDao.findByActIdEqualsAndProductIdEquals(id, pid);</span>
<span class="fc" id="L148">        String key = onsale.cancel(LocalDateTime.now(), user);</span>
<span class="fc" id="L149">        this.redisUtil.del(key);</span>
<span class="fc" id="L150">    }</span>

    /**
     * 取消团购
     *
     * @param id 团购id
     * @param user 操作者
     * @return
     */
    public void cancel(Long shopId, Long id, UserDto user) {
<span class="fc" id="L160">        GrouponAct activity = this.activityDao.findById(id, shopId, GrouponAct.ACTCLASS);</span>
<span class="fc" id="L161">        List&lt;String&gt; keys = activity.cancel(user);</span>
<span class="fc" id="L162">        this.redisUtil.del(keys.toArray(new String[keys.size()]));</span>
<span class="fc" id="L163">    }</span>

    /**
     * 管理员根据id查询预售信息
     *
     * @param shopId 商铺id
     * @param id     活动id
     * @return 预售活动
     */
    public GrouponAct findById(Long id, Long shopId) {
<span class="fc" id="L173">        return this.activityDao.findById(id, shopId, GrouponAct.ACTCLASS);</span>
    }

    /**
     * 查询活动中的商品
     * @param id 活动id
     * @return 商品
     */
    public List&lt;Product&gt; retrieveProduct(Long id){
<span class="fc" id="L182">        GrouponAct act = this.activityDao.findById(id, PLATFORM, GrouponAct.ACTCLASS);</span>
<span class="fc" id="L183">        List&lt;Product&gt; productList = act.getOnsaleList().stream().map(onsale -&gt; this.productDao.findByOnsale(onsale)).collect(Collectors.toList());</span>
<span class="fc" id="L184">        return productList;</span>
    }

    /**
     * 发布活动
     * @param id 活动id
     * @param user 操作者
     */
    public void publishGroupon(Long id, UserDto user){
<span class="nc" id="L193">        GrouponAct act = this.activityDao.findById(id, PLATFORM, GrouponAct.ACTCLASS);</span>
<span class="nc" id="L194">        GrouponAct updateAct = act.publish();</span>
<span class="nc" id="L195">        String key = this.activityDao.save(updateAct, user);</span>
<span class="nc" id="L196">        this.redisUtil.del(key);</span>
<span class="nc" id="L197">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>