<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ProductService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">product</a> &gt; <a href="index.source.html" class="el_package">cn.edu.xmu.oomall.product.service</a> &gt; <span class="el_source">ProductService.java</span></div><h1>ProductService.java</h1><pre class="source lang-java linenums">//School of Informatics Xiamen University, GPL-3.0 license
package cn.edu.xmu.oomall.product.service;

import cn.edu.xmu.javaee.core.exception.BusinessException;
import cn.edu.xmu.javaee.core.model.BloomFilter;
import cn.edu.xmu.javaee.core.model.ReturnNo;
import cn.edu.xmu.javaee.core.model.dto.UserDto;
import cn.edu.xmu.javaee.core.mapper.RedisUtil;
import cn.edu.xmu.javaee.core.util.SnowFlakeIdWorker;
import cn.edu.xmu.oomall.product.dao.ProductDao;
import cn.edu.xmu.oomall.product.dao.bo.*;
import cn.edu.xmu.oomall.product.dao.onsale.OnSaleDao;
import cn.edu.xmu.oomall.product.mapper.openfeign.po.Template;
import lombok.RequiredArgsConstructor;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Propagation;
import org.springframework.transaction.annotation.Transactional;

import java.util.ArrayList;

import java.util.List;
import java.util.Objects;
import java.util.stream.Collectors;

import static cn.edu.xmu.javaee.core.model.Constants.MAX_RETURN;
import static cn.edu.xmu.javaee.core.model.Constants.PLATFORM;

@Service
@Transactional(propagation = Propagation.REQUIRED)
@RequiredArgsConstructor
public class ProductService {

<span class="fc" id="L36">    private static final Logger logger = LoggerFactory.getLogger(ProductService.class);</span>

    private final ProductDao productDao;
    private final RedisUtil redisUtil;
    private final SnowFlakeIdWorker snowFlakeIdWorker;
    private final OnSaleDao onSaleDao;

    /**
     * 根据id获得product对象
     *
     * @param shopId 商铺id
     * @param id product id
     * @return prodcuct对象
     * @throws BusinessException
     */
    public Product findProductById(Long shopId, Long id) throws BusinessException {
<span class="fc" id="L52">        logger.debug(&quot;findProductById: id = {}&quot;, id);</span>
<span class="fc" id="L53">        String key = BloomFilter.PRETECT_FILTERS.get(&quot;ProductId&quot;);</span>
<span class="fc bfc" id="L54" title="All 2 branches covered.">        if (redisUtil.bfExist(key, id)) {</span>
<span class="fc" id="L55">            throw new BusinessException(ReturnNo.RESOURCE_ID_NOTEXIST, String.format(ReturnNo.RESOURCE_ID_NOTEXIST.getMessage(), &quot;产品&quot;, id));</span>
        }
<span class="fc" id="L57">        Product bo = null;</span>
        try {
<span class="fc" id="L59">            bo = this.productDao.findValidById(shopId, id);</span>
<span class="fc" id="L60">        } catch (BusinessException e) {</span>
<span class="pc bpc" id="L61" title="1 of 2 branches missed.">            if (ReturnNo.RESOURCE_ID_NOTEXIST == e.getErrno()) {</span>
<span class="fc" id="L62">                redisUtil.bfAdd(key, id);</span>
            }
<span class="fc" id="L64">            throw e;</span>
<span class="fc" id="L65">        }</span>

<span class="fc" id="L67">        return bo;</span>
    }

    /**
     * 查找有效的商品
     * 采用逻辑分页的方式，前提是少部分数据会被滤去
     * @param shopId
     * @param barCode
     * @param page
     * @param pageSize
     * @return
     * @author wuzhicheng
     */
    public List&lt;Product&gt; retrieveValidProducts(Long shopId, String barCode, String name, Integer page, Integer pageSize) {
<span class="fc" id="L81">        logger.debug(&quot;retrieveProducts: shopId = {}, barCode = {}, name = {}&quot;, shopId, barCode, name);</span>
        //实际读取的数据, 页数越靠后放大系数越小，前5页会放大超过2倍，
<span class="fc" id="L83">        int actualPageSize = page * pageSize * (1 + 5/page);</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">        List&lt;Product&gt; productList = this.productDao.retrieveByShopIdAndBarCodeAndName(shopId, barCode, name, 1, actualPageSize).stream().filter(o -&gt; Product.ONSHELF == o.getStatus()).collect(Collectors.toList());</span>
<span class="nc" id="L85">        int initialSize = productList.size();</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">        if (0 == initialSize ){</span>
            //没有查到则直接返回
<span class="nc" id="L88">            return productList;</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">        }else if (page * pageSize &lt;= initialSize){</span>
            //查到的数据大于返回的数据的位置
<span class="nc" id="L91">            return productList.subList((page - 1) * pageSize, page * pageSize);</span>
        }else {
            //查到的数据小于返回的数据的位置，则放大两倍再查一次
<span class="nc bnc" id="L94" title="All 2 branches missed.">            productList = this.productDao.retrieveByShopIdAndBarCodeAndName(shopId, barCode, name, 1, actualPageSize * 2).stream().filter(o -&gt; Product.ONSHELF == o.getStatus()).collect(Collectors.toList());</span>
<span class="nc bnc" id="L95" title="All 2 branches missed.">            if ((page - 1) * pageSize &gt; productList.size()){</span>
                //查到数据依然小于返回的位置
<span class="nc" id="L97">                return new ArrayList&lt;&gt;();</span>
            }else {
                //计算位置和返回数据中的小值
<span class="nc" id="L100">                int endIndex = Math.min(page * pageSize, productList.size());</span>
<span class="nc" id="L101">                return productList.subList((page - 1) * pageSize, endIndex);</span>
            }
        }
    }

    /**
     * 店家修改货品信息
     *
     * @param shopId 商铺id
     * @param id 商品id
     * @param user 操作用户
     * @param product 修改的属性
     */
    public void updateProduct(Long shopId, Long id, UserDto user, Product product) {
<span class="fc" id="L115">        logger.debug(&quot;updateProduct: productId = {}, product = {}&quot;, id, product);</span>
        //查询Product,防止修改其他商铺的商品或商品不存在
<span class="fc" id="L117">        this.productDao.findNoOnsaleById(shopId, id);</span>
<span class="fc" id="L118">        product.setId(id);</span>
<span class="fc" id="L119">        String key = this.productDao.save(product, user);</span>
<span class="fc" id="L120">        redisUtil.del(key);</span>
<span class="fc" id="L121">    }</span>


    /**
     * 查询商品的运费模板
     *
     * @param shopId
     * @param id
     * @return
     * @author wuzhicheng
     */
    public Template getProductTemplate(Long shopId, Long id) {
<span class="nc" id="L133">        logger.debug(&quot;getProductTemplate: productId = {}&quot;, id);</span>
<span class="nc" id="L134">        Product productById = this.productDao.findValidById(shopId, id);</span>

<span class="nc bnc" id="L136" title="All 4 branches missed.">        if (!Objects.equals(productById.getShopId(), shopId) &amp;&amp; shopId != PLATFORM) {</span>
<span class="nc" id="L137">            throw new BusinessException(ReturnNo.RESOURCE_ID_OUTSCOPE, String.format(ReturnNo.RESOURCE_ID_OUTSCOPE.getMessage(), &quot;商品&quot;, id, shopId));</span>
        }
<span class="nc" id="L139">        return productById.getTemplate();</span>
    }

    /**
     * 店家查看运费模板用到的商品
     *
     * @param shopId
     * @param id
     * @param page
     * @param pageSize
     * @return
     * @author wuzhicheng
     */
    public List&lt;Product&gt; getTemplateProduct(Long shopId, Long id, Integer page, Integer pageSize) {
<span class="fc" id="L153">        logger.debug(&quot;getTemplateProduct: templateId = {}&quot;, id);</span>

<span class="fc" id="L155">        return this.productDao.retrieveProductByTemplateId(shopId,id, page, pageSize);</span>
    }
    /**
     * 店家查看使用特殊物流的商品
     *
     * @param shopId
     * @param id
     * @param page
     * @param pageSize
     * @return
     * @author wuzhicheng
     */
    public List&lt;Product&gt; getLogisticsProduct(Long shopId, Long id, Integer page, Integer pageSize){
<span class="fc" id="L168">        logger.debug(&quot;getLogisticsProduct: Logistics Id = {}&quot;, id);</span>

<span class="fc" id="L170">        List&lt;Product&gt; productList = this.productDao.retrieveProductByLogisticsIdAndShopId(shopId,id, page,pageSize);</span>

<span class="fc" id="L172">        return productList;</span>

    }


    /**
     * 管理员解禁商品
     *
     * @param productId 商品id
     * @param user 操作者
     * @return
     */
    public void allowProduct(Long productId, UserDto user) {
<span class="nc" id="L185">        Product product = this.productDao.findNoOnsaleById(PLATFORM, productId);</span>
<span class="nc" id="L186">        product.allow();</span>
<span class="nc" id="L187">        String key = this.productDao.save(product, user);</span>
<span class="nc" id="L188">        redisUtil.del(key);</span>
<span class="nc" id="L189">    }</span>

    /**
     * 管理员禁售商品
     *
     * @param productId 商品Id
     * @param user 操作者
     * @return
     */
    public void prohibitProduct(Long productId, UserDto user) {
<span class="nc" id="L199">        Product product = this.productDao.findNoOnsaleById(PLATFORM, productId);</span>
<span class="nc" id="L200">        product.ban();</span>
<span class="nc" id="L201">        String key = this.productDao.save(product, user);</span>
<span class="nc" id="L202">        redisUtil.del(key);</span>
<span class="nc" id="L203">    }</span>

    /**
     * 将两个商品设置为相关
     *
     * @param shopId 商铺id
     * @param id 第一个商品 id
     * @param productId 第二个商品id
     * @param user 操作者
     * @return
     */
    public void relateProductId(Long shopId, Long id, Long productId, UserDto user) {
<span class="fc" id="L215">        Product product1 = this.productDao.findNoOnsaleById(shopId, id);</span>
<span class="nc" id="L216">        Product product2 = this.productDao.findNoOnsaleById(shopId,productId);</span>

<span class="nc" id="L218">        Long goodsId1 = null;</span>
<span class="nc" id="L219">        Long goodsId2 = null;</span>
<span class="nc" id="L220">        List&lt;String&gt; keyList = new ArrayList&lt;&gt;(2);</span>
<span class="nc bnc" id="L221" title="All 4 branches missed.">        if (Product.NO_RELATE_PRODUCT == product1.getGoodsId() &amp;&amp; Product.NO_RELATE_PRODUCT == product2.getGoodsId()) {</span>
            //两个都需要更新
<span class="nc" id="L223">            goodsId1 = snowFlakeIdWorker.nextId();</span>
<span class="nc" id="L224">            goodsId2 = goodsId1;</span>
<span class="nc bnc" id="L225" title="All 2 branches missed.">        } else if (Product.NO_RELATE_PRODUCT == product1.getGoodsId()) {</span>
            //更新前面的
<span class="nc" id="L227">            goodsId1 = product2.getGoodsId();</span>
        } else {
            //更新后面的
<span class="nc" id="L230">            goodsId2 = product1.getGoodsId();</span>
        }

<span class="nc" id="L233">        Product updateProduct = new Product();</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">        if (null != goodsId1) {</span>
<span class="nc" id="L235">            updateProduct.setId(id);</span>
<span class="nc" id="L236">            updateProduct.setGoodsId(goodsId1);</span>
<span class="nc" id="L237">            String key = this.productDao.save(updateProduct, user);</span>
<span class="nc" id="L238">            keyList.add(key);</span>
        }
<span class="nc bnc" id="L240" title="All 2 branches missed.">        if (null != goodsId2) {</span>
<span class="nc" id="L241">            updateProduct.setId(productId);</span>
<span class="nc" id="L242">            updateProduct.setGoodsId(goodsId2);</span>
<span class="nc" id="L243">            String key = this.productDao.save(updateProduct, user);</span>
<span class="nc" id="L244">            keyList.add(key);</span>
        }
<span class="nc" id="L246">        this.redisUtil.del(keyList.toArray(new String[keyList.size()]));</span>
<span class="nc" id="L247">    }</span>

    /**
     * 取消两个商品的相关
     *
     * @param shopId 商铺id
     * @param id 第一个商品 id
     * @param user 操作者
     * @return
     */
    public void delRelateProduct(Long shopId, Long id, UserDto user) {
<span class="fc" id="L258">        this.productDao.findNoOnsaleById(shopId, id);</span>

<span class="fc" id="L260">        Product product2 = new Product();</span>
<span class="fc" id="L261">        product2.setId(id);</span>
<span class="fc" id="L262">        product2.setGoodsId(Product.NO_RELATE_PRODUCT);</span>
<span class="fc" id="L263">        String key2 = this.productDao.save(product2, user);</span>
<span class="fc" id="L264">        redisUtil.del(key2);</span>
<span class="fc" id="L265">    }</span>


    /**
     * 删除商品的运费模板
     *
     * @param templateId
     */
    public void removeTemplateId(Long shopId, Long templateId, UserDto userDto) {
<span class="nc" id="L274">        List&lt;Product&gt; productList = this.productDao.retrieveProductByTemplateId(shopId, templateId,0,MAX_RETURN);</span>
<span class="nc" id="L275">        List&lt;String&gt; keys = productList.stream().map(o -&gt; {</span>
<span class="nc" id="L276">            Product updateProduct = new Product();</span>
<span class="nc" id="L277">            updateProduct.setId(o.getId());</span>
<span class="nc" id="L278">            updateProduct.setTemplateId(Product.NO_TEMPLATE);</span>
<span class="nc" id="L279">            return this.productDao.save(o, userDto);</span>
<span class="nc" id="L280">        }).collect(Collectors.toList());</span>
<span class="nc" id="L281">        this.redisUtil.del(keys.toArray(new String[keys.size()]));</span>
<span class="nc" id="L282">    }</span>

    /**
     * 获取某个商品的历史销售信息
     *
     * @param onsaleId onsaleid
     * @return 商品对象
     */
    public Product findByOnsaleId(Long onsaleId) throws BusinessException {
<span class="fc" id="L291">        logger.debug(&quot;findByOnsaleId: onsaleId = {}&quot;, onsaleId);</span>
<span class="fc" id="L292">        String key = BloomFilter.PRETECT_FILTERS.get(&quot;OnsaleId&quot;);</span>

<span class="fc bfc" id="L294" title="All 2 branches covered.">        if (redisUtil.bfExist(key, onsaleId)) {</span>
<span class="fc" id="L295">            throw new BusinessException(ReturnNo.RESOURCE_ID_NOTEXIST, String.format(ReturnNo.RESOURCE_ID_NOTEXIST.getMessage(), &quot;产品&quot;,onsaleId ));</span>
        }
<span class="fc" id="L297">        Product product = null;</span>
        try {
<span class="fc" id="L299">            OnSale onsale = this.onSaleDao.findById(PLATFORM, onsaleId);</span>
<span class="fc" id="L300">            product = this.productDao.findByOnsale(onsale);</span>
<span class="fc" id="L301">        } catch (BusinessException e) {</span>
<span class="pc bpc" id="L302" title="1 of 2 branches missed.">            if (ReturnNo.RESOURCE_ID_NOTEXIST == e.getErrno()) {</span>
<span class="fc" id="L303">                redisUtil.bfAdd(key, onsaleId);</span>
            }
<span class="fc" id="L305">            throw e;</span>
<span class="fc" id="L306">        }</span>
<span class="fc" id="L307">        return product;</span>
    }

    /**
     * 查看Category下的商品
     *
     * @param id
     * @param page
     * @param pageSize
     * @return
     * @author wuzhicheng
     */
    public List&lt;Product&gt; getCategoryProduct( Long id, Integer page, Integer pageSize){
<span class="fc" id="L320">        logger.debug(&quot;getLogisticsProduct: Logistics Id = {}&quot;, id);</span>

<span class="fc" id="L322">        return this.productDao.retrieveProductByCategory(id,page,pageSize);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>