<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CouponActService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">product</a> &gt; <a href="index.source.html" class="el_package">cn.edu.xmu.oomall.product.service</a> &gt; <span class="el_source">CouponActService.java</span></div><h1>CouponActService.java</h1><pre class="source lang-java linenums">//School of Informatics Xiamen University, GPL-3.0 license
package cn.edu.xmu.oomall.product.service;

import cn.edu.xmu.javaee.core.exception.BusinessException;
import cn.edu.xmu.javaee.core.mapper.RedisUtil;
import cn.edu.xmu.javaee.core.model.dto.UserDto;
import cn.edu.xmu.javaee.core.util.CloneFactory;
import cn.edu.xmu.oomall.product.controller.dto.OrderInfoDto;
import cn.edu.xmu.oomall.product.dao.ProductDao;
import cn.edu.xmu.oomall.product.dao.activity.ActivityDao;
import cn.edu.xmu.oomall.product.dao.bo.*;
import cn.edu.xmu.oomall.product.dao.onsale.OnSaleDao;
import cn.edu.xmu.oomall.product.model.strategy.BaseCouponDiscount;
import cn.edu.xmu.oomall.product.model.strategy.Item;
import lombok.RequiredArgsConstructor;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Propagation;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;
import java.util.List;
import java.util.stream.Collectors;

import static cn.edu.xmu.javaee.core.model.Constants.PLATFORM;

@Service
@Transactional(propagation = Propagation.REQUIRED)
@RequiredArgsConstructor
public class CouponActService {

<span class="fc" id="L34">    private static final Logger logger = LoggerFactory.getLogger(CouponActService.class);</span>
    private final ActivityDao activityDao;
    private final ProductDao productDao;
    private final OnSaleDao onsaleDao;
    private final RedisUtil redisUtil;

    /**
     * 新建己方优惠活动
     *
     * @param couponAct 优惠活动
     * @param creator 操作者
     */
    public CouponAct addCouponactivity(CouponAct couponAct, UserDto creator) {
<span class="fc" id="L47">        return this.activityDao.insert(couponAct, creator);</span>
    }

    /**
     * 返回店铺的所有状态优惠活动列表
     *
     * @param shopId    商户Id
     * @param productId 商品id
     * @param status 状态
     * @param page      页码
     * @param pageSize  每页数目
     */
    @Transactional
    public List&lt;CouponAct&gt; retrieveByShopIdAndProductId(Long shopId, Long productId, Integer status, Integer page, Integer pageSize) {
        //通过productId查询活动对象
<span class="fc" id="L62">        return this.activityDao.retrieveByShopIdAndProductId(shopId, productId,CouponAct.ACTCLASS, status, page, pageSize);</span>
    }

    /**
     * 根据id返回优惠活动
     *
     * @param shopId 商户Id
     * @param id     活动Id
     * @return
     */
    @Transactional
    public CouponAct findById(Long shopId, Long id) throws BusinessException {
<span class="fc" id="L74">        return this.activityDao.findById(id, shopId, CouponAct.ACTCLASS);</span>
    }

    /**
     * 修改己方某优惠活动
     *
     * @param shopId 商户Id
     * @param id     活动Id
     */
    public void updateCouponActivityById(Long shopId, Long id, CouponAct couponAct, UserDto modifier) {

<span class="fc" id="L85">        Activity activity = this.activityDao.findById(id, shopId, CouponAct.ACTCLASS);</span>
<span class="fc" id="L86">        couponAct.setId(id);</span>
<span class="fc" id="L87">        couponAct.setObjectId(activity.getObjectId());</span>
<span class="fc" id="L88">        couponAct.setActClass(&quot;couponActDao&quot;);</span>

<span class="fc" id="L90">        String key = this.activityDao.save(couponAct, modifier);</span>
<span class="fc" id="L91">        this.redisUtil.del(key);</span>
<span class="fc" id="L92">    }</span>

    /**
     * 取消己方某优惠活动：取消优惠活动并未修改Activity，修改onsale
     *
     * @param shopId 商户Id
     * @param id     活动Id
     *
     */
    public void cancelCouponAct(Long shopId, Long id){

<span class="fc" id="L103">        CouponAct act = this.activityDao.findById(id, shopId, CouponAct.ACTCLASS);</span>
<span class="fc" id="L104">        act.cancel();</span>
<span class="fc" id="L105">    }</span>

    /**
     * 计算商品优惠价格
     * 2023-12-09
     * @author yuhao shi
     * dgn2-010-syh
     * *@param id 活动Id
     */
    public List&lt;Item&gt; cacuCoupon(Long id, List&lt;OrderInfoDto&gt; orderInfoDtoList){
<span class="fc" id="L115">        Activity activity=this.activityDao.findById(id, PLATFORM, CouponAct.ACTCLASS);</span>
<span class="fc" id="L116">        List&lt;Item&gt; itemList= orderInfoDtoList.stream().map(obj -&gt;{</span>
<span class="fc" id="L117">                OnSale onSale = this.onsaleDao.findById(PLATFORM, obj.getOnsaleId());</span>
<span class="fc" id="L118">                Product product=this.productDao.findByOnsale(onSale);</span>
<span class="fc" id="L119">                Item item= CloneFactory.copy(new Item(), product);</span>
<span class="fc" id="L120">                item.setQuantity(obj.getQuantity());</span>
<span class="fc" id="L121">                item.setOnsaleId(obj.getOnsaleId());</span>
<span class="fc" id="L122">                item.setCouponActivityId(activity.getId());</span>
<span class="fc" id="L123">                return item;</span>
<span class="fc" id="L124">        }).collect(Collectors.toList());</span>

<span class="fc" id="L126">        BaseCouponDiscount baseCouponDiscount= ((CouponAct) activity).getStrategy();</span>
<span class="fc" id="L127">        baseCouponDiscount.compute(itemList);</span>

<span class="fc" id="L129">        return itemList;</span>
    }

    /**
     * 查询优惠活动
     * @param shopId 商铺id
     * @param productId 产品id
     * @param beginTime 晚于结束时间
     * @param endTime 早于结束时间
     * @param page 页
     * @param pageSize 每页数据
     * @return 优惠活动
     */
    public List&lt;CouponAct&gt; retrieveValidByShopIdAndProductIdAndTime(Long shopId, Long productId, LocalDateTime beginTime,LocalDateTime endTime,Integer page,Integer pageSize){
<span class="fc" id="L143">        return this.activityDao.retrieveValidByShopIdAndProductId(shopId, productId, CouponAct.ACTCLASS, beginTime, endTime, page, pageSize);</span>
    }

    /**
     * 查询活动中的商品
     * @param id 活动id
     * @return 商品
     */
    public List&lt;Product&gt; retrieveProduct(Long id){
<span class="fc" id="L152">        CouponAct act = this.activityDao.findById(id, PLATFORM, CouponAct.ACTCLASS);</span>
<span class="fc" id="L153">        List&lt;Product&gt; productList = act.getOnsaleList().stream().map(onsale -&gt; this.productDao.findByOnsale(onsale)).collect(Collectors.toList());</span>
<span class="fc" id="L154">        return productList;</span>
    }

    /**
     * 发布活动
     * @param id 活动id
     * @param user 操作者
     */
    public void publishCouponAct(Long id, UserDto user){
<span class="fc" id="L163">        CouponAct act = this.activityDao.findById(id, PLATFORM, CouponAct.ACTCLASS);</span>
<span class="fc" id="L164">        CouponAct updateAct = act.publish();</span>
<span class="fc" id="L165">        String key = this.activityDao.save(updateAct, user);</span>
<span class="fc" id="L166">        this.redisUtil.del(key);</span>
<span class="fc" id="L167">    }</span>

    /**
     * 管理员将优惠活动加到销售上
     * 注：在dao层实现了对于错误情况的处理，此处无需处理act和onsale
     *
     * @param shopId 商户Id
     * @param actId     活动Id
     * @param onsaleId  销售Id
     * @param creator   操作者
     *
     */
    public void addCouponActToOnsale(Long shopId, Long actId, Long onsaleId, UserDto creator) {
<span class="fc" id="L180">        CouponAct act = this.activityDao.findById(actId, shopId, CouponAct.ACTCLASS);</span>
<span class="fc" id="L181">        OnSale onsale = this.onsaleDao.findById(shopId, onsaleId);</span>
<span class="fc" id="L182">        this.activityDao.insertActivityOnsale(actId, onsaleId, creator);</span>
<span class="fc" id="L183">    }</span>

    /**
     * 管理员将优惠活动从销售上移除
     *
     *
     */
    public void delCouponActFromOnsale(Long shopId, Long actId, Long onsaleId, UserDto deleter) {
<span class="fc" id="L191">        CouponAct act = this.activityDao.findById(actId, shopId, CouponAct.ACTCLASS);</span>
<span class="fc" id="L192">        OnSale onsale = this.onsaleDao.findById(shopId, onsaleId);</span>
<span class="fc" id="L193">        this.activityDao.deleteActivityOnsale(actId, onsaleId, deleter);</span>
<span class="fc" id="L194">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>