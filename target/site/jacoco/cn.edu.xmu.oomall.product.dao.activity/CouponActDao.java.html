<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CouponActDao.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">product</a> &gt; <a href="index.source.html" class="el_package">cn.edu.xmu.oomall.product.dao.activity</a> &gt; <span class="el_source">CouponActDao.java</span></div><h1>CouponActDao.java</h1><pre class="source lang-java linenums">//School of Informatics Xiamen University, GPL-3.0 license

package cn.edu.xmu.oomall.product.dao.activity;

import cn.edu.xmu.javaee.core.exception.BusinessException;
import cn.edu.xmu.javaee.core.model.ReturnNo;
import cn.edu.xmu.javaee.core.util.CloneFactory;
import cn.edu.xmu.oomall.product.dao.bo.Activity;
import cn.edu.xmu.oomall.product.dao.bo.CouponAct;
import cn.edu.xmu.oomall.product.mapper.mongo.CouponActPoMapper;
import cn.edu.xmu.oomall.product.mapper.po.ActivityPo;
import cn.edu.xmu.oomall.product.mapper.po.CouponActPo;
import cn.edu.xmu.oomall.product.model.strategy.BaseCouponDiscount;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Repository;

import java.util.Optional;


@Repository
public class CouponActDao implements ActivityInf{

<span class="fc" id="L26">    private Logger logger = LoggerFactory.getLogger(CouponActDao.class);</span>

    private CouponActPoMapper actPoMapper;


    @Autowired
<span class="fc" id="L32">    public CouponActDao(CouponActPoMapper actPoMapper) {</span>
<span class="fc" id="L33">        this.actPoMapper = actPoMapper;</span>
<span class="fc" id="L34">    }</span>

    @Override
    public Activity getActivity(ActivityPo po)  throws RuntimeException {
<span class="fc" id="L38">        logger.debug(&quot;---getActivity: po = {}&quot;,po);</span>
<span class="fc" id="L39">        Optional&lt;CouponActPo&gt; actPo = actPoMapper.findById(&quot;657302634882bc534d981832&quot;);</span>
<span class="fc" id="L40">        logger.debug(&quot;objid-&gt;657302634882bc534d981832:{},po.objid:{}&quot; ,actPo,po.getObjectId());</span>
<span class="fc" id="L41">        CouponAct bo = CloneFactory.copy(new CouponAct(), po);</span>
<span class="fc" id="L42">        logger.debug(&quot;---copy after getActivity: po = {}&quot;,po);</span>
<span class="fc" id="L43">        Optional&lt;CouponActPo&gt; ret = this.actPoMapper.findById(po.getObjectId());</span>
<span class="fc" id="L44">        logger.debug(&quot;---getActivity: ret = {}&quot;,ret);</span>
<span class="fc" id="L45">        ret.ifPresent(couponActPo -&gt; {</span>
<span class="fc" id="L46">            CloneFactory.copy(bo, couponActPo);</span>
<span class="fc" id="L47">            bo.setStrategy(BaseCouponDiscount.getInstance(couponActPo.getStrategy()).orElse(null));</span>
<span class="fc" id="L48">        });</span>
<span class="fc" id="L49">        logger.debug(&quot;---getActivity: bo = {}&quot;,bo);</span>
<span class="fc" id="L50">        return bo;</span>
    }

    @Override
    public String insert(Activity bo) throws RuntimeException{
<span class="fc" id="L55">        logger.debug(&quot;insert: bo = {}&quot;,bo);</span>
<span class="fc" id="L56">        CouponActPo po = CloneFactory.copy(new CouponActPo(), (CouponAct) bo);</span>
<span class="fc" id="L57">        po.setStrategy(serializeStrategy((CouponAct) bo));</span>
<span class="fc" id="L58">        CouponActPo newPo = this.actPoMapper.insert(po);</span>
<span class="fc" id="L59">        logger.debug(&quot;insert: newPo = {}&quot;,newPo);</span>
<span class="fc" id="L60">        return newPo.getObjectId();</span>
    }

    @Override
    public void save(Activity bo) throws RuntimeException{
<span class="fc" id="L65">        Optional&lt;CouponActPo&gt; ret = this.actPoMapper.findById(bo.getObjectId());</span>
<span class="pc bpc" id="L66" title="1 of 2 branches missed.">        if(ret.isEmpty()){</span>
<span class="nc" id="L67">            throw new BusinessException(ReturnNo.INCONSISTENT_DATA);</span>
        }
<span class="fc" id="L69">        CouponActPo savedPo = ret.get();</span>
<span class="fc" id="L70">        CouponActPo po = CloneFactory.copy(new CouponActPo(), (CouponAct) bo);</span>
<span class="pc bpc" id="L71" title="1 of 2 branches missed.">        if(po.getCouponTime()==null){</span>
<span class="fc" id="L72">            po.setCouponTime(savedPo.getCouponTime());</span>
        }
<span class="pc bpc" id="L74" title="1 of 2 branches missed.">        if(po.getQuantity()==null){</span>
<span class="nc" id="L75">            po.setQuantity(savedPo.getQuantity());</span>
        }
<span class="pc bpc" id="L77" title="1 of 2 branches missed.">        if(po.getQuantityType()==null){</span>
<span class="nc" id="L78">            po.setQuantityType(savedPo.getQuantityType());</span>
        }
<span class="pc bpc" id="L80" title="1 of 2 branches missed.">        if(po.getValidTerm()==null){</span>
<span class="nc" id="L81">            po.setValidTerm(savedPo.getValidTerm());</span>
        }
<span class="pc bpc" id="L83" title="1 of 2 branches missed.">        if(po.getStrategy()==null){</span>
<span class="fc" id="L84">            po.setStrategy(savedPo.getStrategy());</span>
        }
        else {
<span class="nc" id="L87">            po.setStrategy(serializeStrategy((CouponAct) bo));</span>
        }
<span class="fc" id="L89">        this.actPoMapper.save(po);</span>
<span class="fc" id="L90">    }</span>

    private String serializeStrategy(CouponAct bo){
<span class="fc" id="L93">        ObjectMapper mapper = new ObjectMapper();</span>
        try {
<span class="fc" id="L95">            String jsonStrategy = mapper.writeValueAsString(bo.getStrategy());</span>
<span class="fc" id="L96">            logger.debug(&quot;insert: jsonStrategy = {}&quot;,jsonStrategy);</span>
<span class="fc" id="L97">            return jsonStrategy;</span>
        }
<span class="nc" id="L99">        catch(Exception e){</span>
<span class="nc" id="L100">            throw new BusinessException(ReturnNo.INTERNAL_SERVER_ERR);</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>