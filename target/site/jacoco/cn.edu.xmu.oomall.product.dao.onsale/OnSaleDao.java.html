<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>OnSaleDao.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">product</a> &gt; <a href="index.source.html" class="el_package">cn.edu.xmu.oomall.product.dao.onsale</a> &gt; <span class="el_source">OnSaleDao.java</span></div><h1>OnSaleDao.java</h1><pre class="source lang-java linenums">//School of Informatics Xiamen University, GPL-3.0 license
package cn.edu.xmu.oomall.product.dao.onsale;

import cn.edu.xmu.javaee.core.exception.BusinessException;
import cn.edu.xmu.javaee.core.mapper.RedisUtil;
import cn.edu.xmu.javaee.core.model.ReturnNo;
import cn.edu.xmu.javaee.core.model.dto.UserDto;
import cn.edu.xmu.javaee.core.util.CloneFactory;
import cn.edu.xmu.oomall.product.dao.ProductDao;
import cn.edu.xmu.oomall.product.dao.activity.ActivityDao;
import cn.edu.xmu.oomall.product.dao.bo.OnSale;
import cn.edu.xmu.oomall.product.dao.openfeign.ShopDao;
import cn.edu.xmu.oomall.product.mapper.jpa.ActivityOnsalePoMapper;
import cn.edu.xmu.oomall.product.mapper.jpa.OnsalePoMapper;
import cn.edu.xmu.oomall.product.mapper.po.OnsalePo;
import cn.edu.xmu.oomall.product.mapper.rocketmq.OrderMapper;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.cloud.context.config.annotation.RefreshScope;
import org.springframework.context.annotation.Lazy;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.Sort;
import org.springframework.stereotype.Repository;

import java.time.Duration;
import java.time.LocalDateTime;
import java.util.List;
import java.util.Objects;
import java.util.Optional;
import java.util.stream.Collectors;

import static cn.edu.xmu.javaee.core.model.Constants.MAX_RETURN;
import static cn.edu.xmu.javaee.core.model.Constants.PLATFORM;

@Repository
@RefreshScope
public class OnSaleDao {

    private static final String KEY = &quot;O%d&quot;;
    private static final String VALID_KEY = &quot;OV%d&quot;;

<span class="fc" id="L45">    private final static Logger logger = LoggerFactory.getLogger(OnSaleDao.class);</span>

    @Value(&quot;${oomall.onsale.timeout}&quot;)
    private int timeout;

    private OnsalePoMapper onsalePoMapper;

    private ActivityDao activityDao;

    private ShopDao shopDao;

    private ProductDao productDao;

    private RedisUtil redisUtil;

    private ActivityOnsalePoMapper activityOnsalePoMapper;

    private OrderMapper orderMapper;

    @Autowired
    @Lazy
<span class="fc" id="L66">    public OnSaleDao(OnsalePoMapper onsalePoMapper, ActivityDao activityDao, ShopDao shopDao, ProductDao productDao, RedisUtil redisUtil, ActivityOnsalePoMapper activityOnsalePoMapper, OrderMapper orderMapper) {</span>
<span class="fc" id="L67">        this.onsalePoMapper = onsalePoMapper;</span>
<span class="fc" id="L68">        this.activityDao = activityDao;</span>
<span class="fc" id="L69">        this.shopDao = shopDao;</span>
<span class="fc" id="L70">        this.productDao = productDao;</span>
<span class="fc" id="L71">        this.redisUtil = redisUtil;</span>
<span class="fc" id="L72">        this.activityOnsalePoMapper = activityOnsalePoMapper;</span>
<span class="fc" id="L73">        this.orderMapper = orderMapper;</span>
<span class="fc" id="L74">    }</span>

    /**
     * 由po对象获得bo对象
     * 主要是设置波对象中关联的dao对象，并把bo对象存在redis中
     * @param po po对象
     * @param redisKey redis的key，如果是null就不存redis
     * @return bo对象
     */
    private OnSale build(OnsalePo po, Optional&lt;String&gt; redisKey){
<span class="fc" id="L84">        OnSale bo = new OnSale();</span>
<span class="fc" id="L85">        CloneFactory.copy(bo, po);</span>
<span class="fc" id="L86">        this.build(bo);</span>
<span class="fc" id="L87">        redisKey.ifPresent(key -&gt; redisUtil.set(key, bo, timeout));</span>
<span class="fc" id="L88">        return bo;</span>
    }

    /**
     * 设置bo对象关联的dao对象
     * @param bo bo对象
     */
    private OnSale build(OnSale bo){
<span class="fc" id="L96">        bo.setActivityDao(this.activityDao);</span>
<span class="fc" id="L97">        bo.setShopDao(this.shopDao);</span>
<span class="fc" id="L98">        bo.setProductDao(this.productDao);</span>
<span class="fc" id="L99">        bo.setOnSaleDao(this);</span>
<span class="fc" id="L100">        return bo;</span>
    }

    /**
     * 计算过期时间，应该不超过onsale的endtime
     * @author Ming Qiu
     * &lt;p&gt;
     * date: 2022-12-04 19:20
     * @param endTime
     * @return
     */
    private Long getNewTimeout(LocalDateTime endTime) {
<span class="fc" id="L112">        Long diff = Duration.between(LocalDateTime.now(), endTime).toSeconds();</span>
<span class="fc" id="L113">        Long newTimeout = Math.min(this.timeout,  diff);</span>
<span class="fc" id="L114">        return newTimeout;</span>
    }


    /**
     * 获得货品的最近的价格和库存
     *
     * @param productId 商品id
     * @return 规格对象
     */
    public OnSale findLatestValidOnsaleByProductId(Long productId) throws RuntimeException{
<span class="fc" id="L125">        logger.debug(&quot;findLatestValidOnsale: id ={}&quot;,productId);</span>
<span class="fc" id="L126">        String key = String.format(VALID_KEY, productId);</span>

<span class="fc" id="L128">        Integer onsaleId = (Integer) redisUtil.get(key);</span>
<span class="fc bfc" id="L129" title="All 4 branches covered.">        if (onsaleId != null &amp;&amp; !onsaleId.equals(OnSale.NOTEXIST.intValue())) {</span>
            try {
<span class="fc" id="L131">                OnSale bo = this.findById(PLATFORM, Long.valueOf(onsaleId));</span>
<span class="fc" id="L132">                build(bo);</span>
<span class="fc" id="L133">                return bo;</span>
<span class="fc" id="L134">            } catch (BusinessException e) {</span>
<span class="pc bpc" id="L135" title="1 of 2 branches missed.">                if (ReturnNo.RESOURCE_ID_NOTEXIST != e.getErrno()) {</span>
<span class="nc" id="L136">                    throw e;</span>
                }
            }
<span class="fc" id="L139">            return OnSale.builder().id(OnSale.NOTEXIST).build();</span>
        }

<span class="fc" id="L142">        Pageable pageable = PageRequest.of(0, MAX_RETURN, Sort.by(&quot;beginTime&quot;).ascending());</span>
<span class="fc" id="L143">        LocalDateTime now = LocalDateTime.now();</span>
<span class="fc" id="L144">        List&lt;OnsalePo&gt; retObj = this.onsalePoMapper.findByProductIdEqualsAndEndTimeAfter(productId, now, pageable);</span>
<span class="fc bfc" id="L145" title="All 2 branches covered.">        if (retObj.isEmpty()){</span>
<span class="fc" id="L146">            redisUtil.set(key, OnSale.NOTEXIST, timeout);</span>
<span class="fc" id="L147">            return OnSale.builder().id(OnSale.NOTEXIST).build();</span>
        }else{
<span class="fc" id="L149">            OnsalePo po = retObj.stream().limit(1).collect(Collectors.toList()).get(0);</span>
<span class="fc" id="L150">            OnSale bo =  this.build(po, Optional.ofNullable(null));</span>
<span class="fc" id="L151">            redisUtil.set(key, bo.getId(), getNewTimeout(bo.getEndTime()) );</span>
<span class="fc" id="L152">            return bo;</span>
        }
    }

    /**
     * 用id找对象
     * @author Ming Qiu
     * &lt;p&gt;
     * date: 2022-12-04 8:34
     * @param shopId 店铺id
     * @param id onsale id
     * @return
     * @throws RuntimeException
     */
    public OnSale findById(Long shopId, Long id) throws RuntimeException {
<span class="fc" id="L167">        logger.debug(&quot;findById: id ={}&quot;, id);</span>

<span class="fc" id="L169">        String key = String.format(KEY, id);</span>
<span class="fc" id="L170">        OnSale bo = (OnSale) redisUtil.get(key);</span>
<span class="fc bfc" id="L171" title="All 2 branches covered.">        if (bo != null) {</span>
<span class="pc bpc" id="L172" title="1 of 4 branches missed.">            if (!Objects.equals(shopId, bo.getShopId()) &amp;&amp; !PLATFORM.equals(shopId)){</span>
<span class="fc" id="L173">                throw new BusinessException(ReturnNo.RESOURCE_ID_OUTSCOPE,</span>
<span class="fc" id="L174">                        String.format(ReturnNo.RESOURCE_ID_OUTSCOPE.getMessage(), &quot;销售&quot;, id, shopId));</span>
            }
<span class="fc" id="L176">            build(bo);</span>
<span class="fc" id="L177">            return bo;</span>
        }

<span class="fc" id="L180">        Optional&lt;OnsalePo&gt; retObj = this.onsalePoMapper.findById(id);</span>
<span class="fc bfc" id="L181" title="All 2 branches covered.">        if (retObj.isEmpty() ){</span>
<span class="fc" id="L182">            throw new BusinessException(ReturnNo.RESOURCE_ID_NOTEXIST, String.format(ReturnNo.RESOURCE_ID_NOTEXIST.getMessage(), &quot;销售&quot;, id));</span>
        }else{
<span class="fc" id="L184">            OnsalePo po = retObj.get();</span>
<span class="fc bfc" id="L185" title="All 4 branches covered.">            if (!shopId.equals(po.getShopId()) &amp;&amp; !PLATFORM.equals(shopId)){</span>
<span class="fc" id="L186">                throw new BusinessException(ReturnNo.RESOURCE_ID_OUTSCOPE, String.format(ReturnNo.RESOURCE_ID_OUTSCOPE.getMessage(), &quot;销售&quot;,id, shopId));</span>
            }
<span class="fc" id="L188">            return this.build(po, Optional.of(key));</span>
        }
    }
    /*
     * 保存Onsale到数据库中去
     * @param onsale Onsale对象
     * @param user 操作管理员对象
     * @return new onsale object with id
     */
    public OnSale insert(OnSale onsale, UserDto user) {
<span class="fc" id="L198">        logger.debug(&quot;insert: onsale={}&quot;,onsale);</span>
<span class="fc" id="L199">        hasConflictOnsale(onsale);</span>
<span class="fc" id="L200">        onsale.setCreator(user);</span>
<span class="fc" id="L201">        onsale.setGmtCreate(LocalDateTime.now());</span>
<span class="fc" id="L202">        OnsalePo onsalePo = CloneFactory.copy(new OnsalePo(), onsale);</span>
<span class="fc" id="L203">        onsalePo.setId(null);</span>
<span class="fc" id="L204">        OnsalePo newPo = this.onsalePoMapper.save(onsalePo);</span>
<span class="fc" id="L205">        logger.debug(&quot;insert: newPo={}&quot;, newPo);</span>
<span class="fc" id="L206">        onsale.setId(newPo.getId());</span>
<span class="fc" id="L207">        return onsale;</span>
    }

    /**
     *  //判断是否存在时间重叠的onsale
     * @param onsale 判断的onsale对象
     * @throws BusinessException
     */
    private void hasConflictOnsale(OnSale onsale) throws BusinessException{
<span class="fc" id="L216">        logger.debug(&quot;hasConflictOnsale: onsale = {}&quot;, onsale);</span>
<span class="fc bfc" id="L217" title="All 6 branches covered.">        if ( null == onsale.getProductId() &amp;&amp; null == onsale.getBeginTime() &amp;&amp; null == onsale.getEndTime()){</span>
<span class="fc" id="L218">            throw new IllegalArgumentException(&quot;OnsaleDao.hasConflictOnsale: onsale's productId, beginTime and endTime can not be null&quot;);</span>
        }

<span class="fc" id="L221">        PageRequest pageable = PageRequest.of(0,MAX_RETURN, Sort.by(Sort.Direction.ASC, &quot;beginTime&quot;));</span>
<span class="fc" id="L222">        List&lt;OnsalePo&gt; poList =  this.onsalePoMapper.findOverlap(onsale.getProductId(), onsale.getBeginTime(), onsale.getEndTime(), pageable);</span>
<span class="fc bfc" id="L223" title="All 2 branches covered.">        if (!poList.isEmpty()){</span>
<span class="fc" id="L224">            logger.debug(&quot;hasConflictOnsale: poList Size = {}, onsale's id = {}&quot;,poList.size(), onsale.getId());</span>
<span class="pc bpc" id="L225" title="1 of 2 branches missed.">            if (null != onsale.getId()) {</span>
                //修改的目标onsale不计算在重复范围内
<span class="nc bnc" id="L227" title="All 2 branches missed.">                poList = poList.stream().filter(o -&gt; !onsale.getId().equals(o.getId())).collect(Collectors.toList());</span>
            }

<span class="pc bpc" id="L230" title="1 of 2 branches missed.">            if (poList.size() &gt; 0) {</span>
<span class="fc" id="L231">                throw new BusinessException(ReturnNo.GOODS_ONSALE_CONFLICT, String.format(ReturnNo.GOODS_ONSALE_CONFLICT.getMessage(), poList.get(0).getId()));</span>
            }
        }
<span class="fc" id="L234">    }</span>

    /**
     * 修改Onsale,保存到数据库
     * @param onsale
     * @param user
     * @return redisKey
     */
    public String save(OnSale onsale, UserDto user) throws BusinessException{
<span class="fc" id="L243">        logger.debug(&quot;save: onsale={}&quot;,onsale);</span>
<span class="fc" id="L244">        this.hasConflictOnsale(onsale);</span>
<span class="fc" id="L245">        onsale.setModifier(user);</span>
<span class="fc" id="L246">        onsale.setGmtModified(LocalDateTime.now());</span>
<span class="fc" id="L247">        OnsalePo onsalePo = CloneFactory.copy(new OnsalePo(), onsale);</span>
<span class="fc" id="L248">        OnsalePo newPo = this.onsalePoMapper.save(onsalePo);</span>
<span class="pc bpc" id="L249" title="1 of 2 branches missed.">        if (OnSale.NOTEXIST.equals(newPo.getId())){</span>
<span class="nc" id="L250">            throw new BusinessException(ReturnNo.RESOURCE_ID_NOTEXIST, String.format(ReturnNo.RESOURCE_ID_NOTEXIST.getMessage(), &quot;销售&quot;, onsalePo.getId()));</span>
        }
<span class="fc" id="L252">        return String.format(KEY,newPo.getId());</span>
    }

    /**
     * 根据productId 获得Onsale对象集合,按照开始时间倒序
     * @param productId 产品id
     * @param page 页
     * @param pageSize 每页数量
     * @return 查询的onsale对象
     */
    public List&lt;OnSale&gt; retrieveByProductId(Long productId, Integer page, Integer pageSize) {
<span class="fc" id="L263">        Pageable pageable=PageRequest.of(page - 1,pageSize, Sort.by(&quot;beginTime&quot;).descending());</span>
<span class="fc" id="L264">        List&lt;OnsalePo&gt; retObj = this.onsalePoMapper.findByProductIdIs(productId, pageable);</span>
<span class="fc" id="L265">        return retObj.stream().map(po -&gt; CloneFactory.copy(new OnSale(), po)).collect(Collectors.toList());</span>
    }

    /**
     * 按照活动id返回Onsale
     * @param actId 活动id
     * @param page 页数，从第1页开始
     * @param pageSize 每页数据
     * @return 返回onsale对象
     */
    public List&lt;OnSale&gt; retrieveByActId(Long actId, Integer page, Integer pageSize) throws RuntimeException {
<span class="fc" id="L276">        logger.debug(&quot;retrieveByActId: actId = {}, page = {}, pageSize = {}&quot;,actId, page, pageSize);</span>
<span class="fc bfc" id="L277" title="All 2 branches covered.">        if (null == actId) {</span>
<span class="fc" id="L278">            return null;</span>
        }
<span class="fc" id="L280">        Pageable pageable=PageRequest.of(page - 1,pageSize);</span>
<span class="fc" id="L281">        List&lt;OnsalePo&gt; actOnsalePos = this.onsalePoMapper.findByActIdEquals(actId, pageable);</span>
<span class="fc" id="L282">        return actOnsalePos.stream().map(po -&gt; this.build(po, Optional.empty())).collect(Collectors.toList());</span>
    }

    /**
     * 删除onsale
     * 在send-delete-onsale-topic发送消息看是否存在订单，如果不存在则在reply-del-onsale-topic收到回复去物理删除，如果未收到回复则不删除
     * @author Rui Li
     * @task 2023-dgn2-007
     */
    public void tryToDel(OnSale onSale, UserDto user)
    {
<span class="fc" id="L293">        this.orderMapper.sendDelMessage(onSale,user);</span>
<span class="fc" id="L294">    }</span>

    /**
     * 物理删除onsale对象
     * @param onsaleId
     */
    public void delete(Long onsaleId){
<span class="fc" id="L301">        this.onsalePoMapper.deleteById(onsaleId);</span>
<span class="fc" id="L302">    }</span>

    /**
     * 删除所有相关的onsale
     * @param actId 活动id
     * @throws BusinessException
     */
    public void deleteRelateOnsales(Long actId) {
<span class="fc" id="L310">        this.activityOnsalePoMapper.deleteByActIdEquals(actId);</span>
<span class="fc" id="L311">    }</span>

    /**
     * 根据活动ID和产品Id找到对应的销售
     * @param activityId
     * @param productId
     * @return
     *
     * @author WuTong
     * @task 2023-dgn2-008
     */
    public OnSale findByActIdEqualsAndProductIdEquals(Long activityId, Long productId) {
<span class="fc" id="L323">        OnsalePo onsalePo = this.onsalePoMapper.findByActIdEqualsAndProductIdEquals(activityId, productId);</span>
<span class="pc bpc" id="L324" title="1 of 2 branches missed.">        if (!Objects.isNull(onsalePo)) {</span>
<span class="fc" id="L325">            String key = String.format(KEY, onsalePo.getId());</span>
<span class="fc" id="L326">            return this.build(onsalePo, Optional.of(key));</span>
        } else {
<span class="nc" id="L328">            throw new BusinessException(ReturnNo.RESOURCE_ID_NOTEXIST, String.format(ReturnNo.RESOURCE_ID_NOTEXIST.getMessage(), &quot;销售&quot;, onsalePo.getId()));</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>