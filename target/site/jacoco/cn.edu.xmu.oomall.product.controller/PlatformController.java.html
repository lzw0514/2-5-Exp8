<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PlatformController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">product</a> &gt; <a href="index.source.html" class="el_package">cn.edu.xmu.oomall.product.controller</a> &gt; <span class="el_source">PlatformController.java</span></div><h1>PlatformController.java</h1><pre class="source lang-java linenums">//School of Informatics Xiamen University, GPL-3.0 license
package cn.edu.xmu.oomall.product.controller;

import cn.edu.xmu.javaee.core.aop.Audit;
import cn.edu.xmu.javaee.core.aop.LoginUser;
import cn.edu.xmu.javaee.core.exception.BusinessException;
import cn.edu.xmu.javaee.core.model.ReturnNo;
import cn.edu.xmu.javaee.core.model.ReturnObject;
import cn.edu.xmu.javaee.core.model.vo.IdNameTypeVo;
import cn.edu.xmu.javaee.core.model.dto.UserDto;
import cn.edu.xmu.javaee.core.util.CloneFactory;
import cn.edu.xmu.javaee.core.validation.NewGroup;
import cn.edu.xmu.javaee.core.validation.UpdateGroup;
import cn.edu.xmu.oomall.product.controller.dto.CategoryDto;
import cn.edu.xmu.oomall.product.controller.dto.CommissionRatioDto;
import cn.edu.xmu.oomall.product.controller.vo.CategoryVo;
import cn.edu.xmu.oomall.product.dao.bo.Category;
import cn.edu.xmu.oomall.product.dao.bo.Product;
import cn.edu.xmu.oomall.product.service.CategoryService;
import cn.edu.xmu.oomall.product.service.GrouponActService;
import cn.edu.xmu.oomall.product.service.ProductDraftService;
import cn.edu.xmu.oomall.product.service.ProductService;
import lombok.RequiredArgsConstructor;
import org.springframework.transaction.annotation.Propagation;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.stream.Collectors;

import static cn.edu.xmu.javaee.core.model.Constants.PLATFORM;

@RestController /*Restful的Controller对象*/
@RequestMapping(value = &quot;/platforms/{shopId}&quot;, produces = &quot;application/json;charset=UTF-8&quot;)
@RequiredArgsConstructor
public class PlatformController {

    private final CategoryService categoryService;
    private final ProductService productService;
    private final ProductDraftService productDraftService;
    private final GrouponActService grouponActService;

    /**
     * 获得二级分类
     * @param id
     * @return
     */
    @GetMapping(&quot;/categories/{id}/subcategories&quot;)
    @Transactional(propagation = Propagation.REQUIRED)
    @Audit(departName = &quot;platforms&quot;)
    public ReturnObject getSubCategories(@PathVariable(&quot;id&quot;) Long id,
                                         @PathVariable(&quot;shopId&quot;) Long shopId)
    {
<span class="nc bnc" id="L55" title="All 2 branches missed.">        if (!PLATFORM.equals(shopId))</span>
<span class="nc" id="L56">            throw new BusinessException(ReturnNo.AUTH_NO_RIGHT, &quot;平台管理员才可以查看分类详细&quot;);</span>
<span class="nc" id="L57">        List&lt;Category&gt; categories = this.categoryService.retrieveSubCategories(id);</span>
<span class="nc" id="L58">        List&lt;CategoryVo&gt; ret =  categories.stream().map(category -&gt; new CategoryVo(category)).collect(Collectors.toList());</span>
<span class="nc" id="L59">        return new ReturnObject(ret);</span>
    }

    /**
     * 增加二级分类
     * @param shopId 商铺id
     * @param id 一级分类id
     * @param vo 属性
     * @param creator 操作者
     * @return
     */
    @PostMapping(&quot;/categories/{id}/subcategories&quot;)
    @Audit(departName = &quot;platforms&quot;)
    public ReturnObject createSubCategories(@PathVariable(&quot;shopId&quot;) Long shopId,
                                             @PathVariable(&quot;id&quot;) Long id,
                                             @Validated(NewGroup.class) @RequestBody CategoryDto vo,
                                             @LoginUser UserDto creator) {
<span class="nc bnc" id="L76" title="All 2 branches missed.">        if (!PLATFORM.equals(shopId))</span>
<span class="nc" id="L77">            throw new BusinessException(ReturnNo.AUTH_NO_RIGHT, &quot;平台管理员才可以修改分类&quot;);</span>
<span class="nc" id="L78">        Category category = CloneFactory.copy(new Category(), vo);</span>
<span class="nc" id="L79">        Category newCategory=this.categoryService.createSubCategory(id, category, creator);</span>
<span class="nc" id="L80">        IdNameTypeVo dto= IdNameTypeVo.builder().id(newCategory.getId()).name(newCategory.getName()).build();</span>
<span class="nc" id="L81">        return new ReturnObject(ReturnNo.CREATED,dto);</span>
    }

    /**
     * 管理员修改分类
     * @param shopId 商铺id
     * @param id 分类id
     * @param vo 修改属性
     * @param modifier 操作者
     * @return
     */
    @PutMapping(&quot;/categories/{id}&quot;)
    @Audit(departName = &quot;platforms&quot;)
    public ReturnObject updateCategory(@PathVariable(&quot;shopId&quot;) Long shopId,
                                       @PathVariable(&quot;id&quot;) Long id,
                                       @Validated(UpdateGroup.class) @RequestBody CategoryDto vo,
                                       @LoginUser UserDto modifier) {
<span class="nc bnc" id="L98" title="All 2 branches missed.">        if (!PLATFORM.equals(shopId))</span>
<span class="nc" id="L99">            throw new BusinessException(ReturnNo.AUTH_NO_RIGHT, &quot;平台管理员才可以修改分类&quot;);</span>
<span class="nc" id="L100">        Category category = CloneFactory.copy(new Category(), vo);</span>
<span class="nc" id="L101">        category.setId(id);</span>
<span class="nc" id="L102">        this.categoryService.updateCategory(category, modifier);</span>
<span class="nc" id="L103">        return new ReturnObject();</span>
    }

    @DeleteMapping(&quot;/categories/{id}&quot;)
    @Audit(departName = &quot;platforms&quot;)
    public ReturnObject deleteCategory(@PathVariable(&quot;shopId&quot;) Long shopId,
                                       @PathVariable(&quot;id&quot;) Long id,
                                       @LoginUser UserDto userDto) {
<span class="nc bnc" id="L111" title="All 2 branches missed.">        if (!shopId.equals(PLATFORM))</span>
<span class="nc" id="L112">            throw new BusinessException(ReturnNo.AUTH_NO_RIGHT, &quot;平台管理员才可以修改分类&quot;);</span>
<span class="nc" id="L113">        this.categoryService.deleteCategory(id, userDto);</span>
<span class="nc" id="L114">        return new ReturnObject();</span>
    }

    /**
     * 管理员修改分账比例
     * @param shopId 店铺id
     * @param id 商品id
     * @param user 操作者
     * @return
     */
    @PutMapping(&quot;/products/{id}/commissionratio&quot;)
    @Audit(departName = &quot;platforms&quot;)
    public ReturnObject putProductCommissionRatio(@PathVariable Long shopId, @PathVariable Long id, @LoginUser UserDto user,
                                                  @RequestBody @Validated CommissionRatioDto dto){
<span class="nc bnc" id="L128" title="All 2 branches missed.">        if (!shopId.equals(PLATFORM)) {</span>
<span class="nc" id="L129">            throw new BusinessException(ReturnNo.RESOURCE_ID_OUTSCOPE, String.format(ReturnNo.RESOURCE_ID_OUTSCOPE.getMessage(), &quot;商品&quot;, id, shopId));</span>
        }
<span class="nc" id="L131">        Product product=new Product();</span>
<span class="nc" id="L132">        product.setCommissionRatio(dto.getCommissionRatio());</span>
<span class="nc" id="L133">        this.productService.updateProduct(shopId,id,user,product);</span>
<span class="nc" id="L134">        return new ReturnObject();</span>
    }

    /**
     * 管理员解禁商品
     * @param shopId
     * @param id
     * @param user
     * @return
     */
    @PutMapping(&quot;/products/{id}/allow&quot;)
    @Audit(departName = &quot;platforms&quot;)
    public ReturnObject allowGoods(@PathVariable Long shopId, @PathVariable Long id, @LoginUser UserDto user){
<span class="nc bnc" id="L147" title="All 2 branches missed.">        if (!shopId.equals(PLATFORM)) {</span>
<span class="nc" id="L148">            throw new BusinessException(ReturnNo.RESOURCE_ID_OUTSCOPE, String.format(ReturnNo.RESOURCE_ID_OUTSCOPE.getMessage(), &quot;商品&quot;, id, shopId));</span>
        }
<span class="nc" id="L150">        this.productService.allowProduct(id, user);</span>
<span class="nc" id="L151">        return new ReturnObject();</span>
    }

    /**
     * 平台管理员禁售商品
     * @param shopId
     * @param id
     * @param user
     * @return
     */
    @PutMapping(&quot;/products/{id}/prohibit&quot;)
    @Audit(departName = &quot;platforms&quot;)
    public ReturnObject prohibitGoods(@PathVariable Long shopId, @PathVariable Long id, @LoginUser UserDto user){
<span class="nc bnc" id="L164" title="All 2 branches missed.">        if (!shopId.equals(PLATFORM)) {</span>
<span class="nc" id="L165">            throw new BusinessException(ReturnNo.RESOURCE_ID_OUTSCOPE, String.format(ReturnNo.RESOURCE_ID_OUTSCOPE.getMessage(), &quot;商品&quot;, id, shopId));</span>
        }
<span class="nc" id="L167">        this.productService.prohibitProduct(id, user);</span>
<span class="nc" id="L168">        return new ReturnObject();</span>
    }

    /**
     * 货品发布
     * @param shopId
     * @param id
     * @param user
     * @return
     */
    @PutMapping(&quot;/draftproducts/{id}/publish&quot;)
    @Audit(departName = &quot;platforms&quot;)
    public ReturnObject publishProduct(@PathVariable Long shopId, @PathVariable Long id, @RequestBody CommissionRatioDto vo, @LoginUser UserDto user){

<span class="nc bnc" id="L182" title="All 2 branches missed.">        if(PLATFORM != shopId){</span>
            //只有平台管理员能发布商品
<span class="nc" id="L184">            throw new BusinessException(ReturnNo.RESOURCE_ID_OUTSCOPE, String.format(ReturnNo.RESOURCE_ID_OUTSCOPE.getMessage(), &quot;上架商品&quot;, id, shopId));</span>
        }
<span class="nc bnc" id="L186" title="All 4 branches missed.">        if(vo.getCommissionRatio()&gt;100 || vo.getCommissionRatio()&lt;0){</span>
<span class="nc" id="L187">            throw new BusinessException(ReturnNo.FIELD_NOTVALID,String.format(ReturnNo.FIELD_NOTVALID.getMessage(),&quot;CommissionRatio&quot;));</span>
        }
<span class="nc" id="L189">        Integer commissionRatio = vo.getCommissionRatio();</span>
<span class="nc" id="L190">        Product product = this.productDraftService.publishProduct(shopId, id, commissionRatio, user);</span>
<span class="nc" id="L191">        IdNameTypeVo dto = IdNameTypeVo.builder().id(product.getId()).name(product.getName()).build();</span>
<span class="nc" id="L192">        return new ReturnObject(dto);</span>
    }

    /**
     * 平台管理员审核团购活动
     */
    @Audit(departName = &quot;platforms&quot;)
    @PutMapping(&quot;/groupons/{id}/publish&quot;)
    public ReturnObject publishGrouponAct(@PathVariable Long shopId, @PathVariable Long id, UserDto userDto){
<span class="nc bnc" id="L201" title="All 2 branches missed.">        if (PLATFORM != shopId){</span>
<span class="nc" id="L202">            throw new BusinessException(ReturnNo.RESOURCE_ID_OUTSCOPE, &quot;平台管理员才能审核&quot;);</span>
        }
<span class="nc" id="L204">        this.grouponActService.publishGroupon(id, userDto);</span>
<span class="nc" id="L205">        return new ReturnObject();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>