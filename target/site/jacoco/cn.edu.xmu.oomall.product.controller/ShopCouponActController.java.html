<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ShopCouponActController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">product</a> &gt; <a href="index.source.html" class="el_package">cn.edu.xmu.oomall.product.controller</a> &gt; <span class="el_source">ShopCouponActController.java</span></div><h1>ShopCouponActController.java</h1><pre class="source lang-java linenums">//School of Informatics Xiamen University, GPL-3.0 license
package cn.edu.xmu.oomall.product.controller;

import cn.edu.xmu.javaee.core.aop.Audit;
import cn.edu.xmu.javaee.core.aop.LoginUser;
import cn.edu.xmu.javaee.core.exception.BusinessException;
import cn.edu.xmu.javaee.core.model.ReturnNo;
import cn.edu.xmu.javaee.core.model.ReturnObject;
import cn.edu.xmu.javaee.core.model.vo.PageVo;
import cn.edu.xmu.javaee.core.model.dto.UserDto;
import cn.edu.xmu.javaee.core.util.CloneFactory;
import cn.edu.xmu.javaee.core.validation.NewGroup;
import cn.edu.xmu.oomall.product.controller.dto.CouponActDto;
import cn.edu.xmu.oomall.product.dao.bo.CouponAct;
import cn.edu.xmu.oomall.product.service.CouponActService;
import cn.edu.xmu.oomall.product.controller.vo.CouponActVo;
import cn.edu.xmu.oomall.product.controller.vo.SimpleCouponActVo;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.stream.Collectors;

import static cn.edu.xmu.javaee.core.model.Constants.PLATFORM;


/**
 * 优惠控制器
 * @author Liang nan、Fan ninghan
 */
@RestController /*Restful的Controller对象*/
@RequestMapping(value = &quot;/shops/{shopId}&quot;, produces = &quot;application/json;charset=UTF-8&quot;)
@RequiredArgsConstructor
<span class="fc" id="L36">@Slf4j</span>
public class ShopCouponActController {

    private final CouponActService couponActService;

    /**
     * 管理员新建己方优惠活动
     *
     * @param shopId
     * @param vo
     * @param creator
     *
     */
    @PostMapping(&quot;/couponactivities&quot;)
    @Audit(departName = &quot;shops&quot;)
    public ReturnObject addCouponactivity(@PathVariable Long shopId,
                                          @Validated(value = {NewGroup.class}) @RequestBody CouponActDto vo,
                                          @LoginUser UserDto creator) {
<span class="fc" id="L54">        log.debug(&quot;vo = {}&quot;, vo);</span>
<span class="fc" id="L55">        CouponAct act = CloneFactory.copy(new CouponAct(), vo);</span>
<span class="fc" id="L56">        log.debug(&quot;act = {}&quot;, act);</span>
<span class="fc" id="L57">        act.setShopId(shopId);</span>
<span class="fc" id="L58">        act.setActClass(CouponAct.ACTCLASS);</span>
<span class="fc" id="L59">        CouponAct newAct = this.couponActService.addCouponactivity(act, creator);</span>
<span class="fc" id="L60">        return new ReturnObject(ReturnNo.CREATED, CloneFactory.copy(new SimpleCouponActVo(), newAct));</span>
    }

    /**
     * 查看店铺的所有状态优惠活动列表
     *
     * @param shopId
     * @param productId (not required)
     * @param status (not required)
     * @param page (not required)
     * @param pageSize (not required)
     *
     */
    @GetMapping(&quot;/couponactivities&quot;)
    @Audit(departName = &quot;shops&quot;)
    public ReturnObject getCouponactivity(@PathVariable(&quot;shopId&quot;) Long shopId,
                                          @RequestParam(required = false) Long productId,
                                          @RequestParam(required = false) Integer status,
                                          @RequestParam(required = false, defaultValue = &quot;1&quot;) Integer page,
                                          @RequestParam(required = false, defaultValue = &quot;10&quot;) Integer pageSize) {
<span class="fc" id="L80">        List&lt;CouponAct&gt; acts= this.couponActService.retrieveByShopIdAndProductId(shopId, productId, status, page, pageSize);</span>
<span class="fc" id="L81">        List&lt;SimpleCouponActVo&gt; couponActList = acts.stream()</span>
<span class="fc" id="L82">                .map(couponAct -&gt; CloneFactory.copy(new SimpleCouponActVo(), couponAct)).collect(Collectors.toList());</span>
<span class="fc" id="L83">        return new ReturnObject(new PageVo&lt;&gt;(couponActList, page, pageSize));</span>
    }

    /**
     * 查看优惠活动详情
     *
     * @param shopId
     * @param id
     *
     */
    @GetMapping(&quot;/couponactivities/{id}&quot;)
    @Audit(departName = &quot;shops&quot;)
    public ReturnObject getCouponActDetailed(@PathVariable(&quot;shopId&quot;) Long shopId,
                                       @PathVariable(&quot;id&quot;) Long id,
                                       @LoginUser UserDto user) {
<span class="fc" id="L98">        CouponAct act = this.couponActService.findById(shopId, id);</span>
<span class="fc" id="L99">        return new ReturnObject(CloneFactory.copy(new CouponActVo(),act));</span>
    }

    /**
     * 管理员修改己方某优惠活动
     *
     * @param shopId
     * @param id
     * @param couponActDto
     *
     */
    @PutMapping(&quot;/couponactivities/{id}&quot;)
    @Audit(departName = &quot;shops&quot;)
    public ReturnObject putCouponActProduct(@PathVariable(&quot;shopId&quot;) Long shopId,
                                            @PathVariable(&quot;id&quot;) Long id,
                                            @Validated @RequestBody CouponActDto couponActDto,
                                            @LoginUser UserDto modifier) {
<span class="fc" id="L116">        CouponAct bo = CloneFactory.copy(new CouponAct(), couponActDto);</span>
<span class="fc" id="L117">        log.debug(&quot;put: bo = {}&quot;, bo);</span>
<span class="fc" id="L118">        couponActService.updateCouponActivityById(shopId, id, bo, modifier);</span>
<span class="fc" id="L119">        return new ReturnObject();</span>
    }

    /**
     * 管理员取消己方某优惠活动
     * 实现：删除ActivityOnsale表中actId对应的记录
     *
     * @param shopId
     * @param id
     *
     */
    @DeleteMapping(&quot;/couponactivities/{id}&quot;)
    @Audit(departName = &quot;shops&quot;)
    public ReturnObject delCouponAct(@PathVariable(&quot;shopId&quot;) Long shopId,
                                     @PathVariable(&quot;id&quot;) Long id,
                                     @LoginUser UserDto modifier) {
<span class="fc" id="L135">        this.couponActService.cancelCouponAct(shopId, id);</span>
<span class="fc" id="L136">        return new ReturnObject();</span>
    }

    /**
     * 管理员审核优惠活动
     *
     * @param shopId
     * @param id
     * @param userDto
     */
    @Audit(departName = &quot;shops&quot;)
    @PutMapping(&quot;/couponactivities/{id}/publish&quot;)
    public ReturnObject publishCouponAct(@PathVariable Long shopId, @PathVariable Long id, @LoginUser UserDto userDto){
<span class="fc bfc" id="L149" title="All 2 branches covered.">        if (PLATFORM != shopId){</span>
<span class="fc" id="L150">            throw new BusinessException(ReturnNo.RESOURCE_ID_OUTSCOPE, &quot;平台管理员才能审核&quot;);</span>
        }
<span class="fc" id="L152">        this.couponActService.publishCouponAct(id, userDto);</span>
<span class="fc" id="L153">        return new ReturnObject();</span>
    }

    /**
     * 管理员将优惠活动加到销售上
     *
     * @param shopId
     * @param id
     * @param sid
     * @param creator
     */
    @PostMapping(&quot;/couponactivities/{id}/onsales/{sid}&quot;)
    @Audit(departName = &quot;shops&quot;)
    public ReturnObject addCouponActToOnsale(@PathVariable Long shopId,
                                             @PathVariable Long id,
                                             @PathVariable Long sid,
                                             @LoginUser UserDto creator) {
<span class="fc" id="L170">        this.couponActService.addCouponActToOnsale(shopId, id, sid, creator);</span>
<span class="fc" id="L171">        return new ReturnObject(ReturnNo.CREATED);</span>
    }

    /**
     * 管理员将销售上的优惠活动取消
     *
     * @author Fan ninghan
     *
     * @param shopId
     * @param id
     * @param sid
     * @param deleter
     *
     */
    @DeleteMapping(&quot;/couponactivities/{id}/onsales/{sid}&quot;)
    @Audit(departName = &quot;shops&quot;)
    public ReturnObject delCouponActFromOnsale(@PathVariable Long shopId,
                                               @PathVariable Long id,
                                               @PathVariable Long sid,
                                               @LoginUser UserDto deleter) {
<span class="fc" id="L191">        this.couponActService.delCouponActFromOnsale(shopId, id, sid, deleter);</span>
<span class="fc" id="L192">        return new ReturnObject();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>