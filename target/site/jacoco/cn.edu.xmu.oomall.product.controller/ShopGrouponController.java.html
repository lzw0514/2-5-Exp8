<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ShopGrouponController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">product</a> &gt; <a href="index.source.html" class="el_package">cn.edu.xmu.oomall.product.controller</a> &gt; <span class="el_source">ShopGrouponController.java</span></div><h1>ShopGrouponController.java</h1><pre class="source lang-java linenums">package cn.edu.xmu.oomall.product.controller;


import cn.edu.xmu.javaee.core.aop.Audit;
import cn.edu.xmu.javaee.core.aop.LoginUser;
import cn.edu.xmu.javaee.core.exception.BusinessException;
import cn.edu.xmu.javaee.core.model.ReturnNo;
import cn.edu.xmu.javaee.core.model.ReturnObject;
import cn.edu.xmu.javaee.core.model.vo.IdNameTypeVo;
import cn.edu.xmu.javaee.core.model.vo.PageVo;
import cn.edu.xmu.javaee.core.model.dto.UserDto;
import cn.edu.xmu.javaee.core.util.CloneFactory;
import cn.edu.xmu.javaee.core.validation.NewGroup;
import cn.edu.xmu.javaee.core.validation.UpdateGroup;
import cn.edu.xmu.oomall.product.controller.dto.GrouponActDto;
import cn.edu.xmu.oomall.product.controller.dto.OnSaleDto;
import cn.edu.xmu.oomall.product.dao.bo.GrouponAct;
import cn.edu.xmu.oomall.product.dao.bo.OnSale;
import cn.edu.xmu.oomall.product.service.GrouponActService;
import cn.edu.xmu.oomall.product.controller.vo.FullGrouponActVo;
import cn.edu.xmu.oomall.product.controller.vo.SimpleGrouponActVo;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.transaction.annotation.Propagation;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.stream.Collectors;

import static cn.edu.xmu.javaee.core.model.Constants.PLATFORM;

/**
 * 团购控制器
 * @author prophesier
 */
@RestController /*Restful的Controller对象*/
@RequestMapping(value = &quot;/shops/{shopId}&quot;, produces = &quot;application/json;charset=UTF-8&quot;)
@RequiredArgsConstructor
<span class="fc" id="L41">@Slf4j</span>
public class ShopGrouponController {

    private final GrouponActService grouponActService;

    /**
     * 商户查看特定团购详情
     * @param shopId
     * @param actId
     * @return
     */
    @GetMapping(&quot;/groupons/{id}&quot;)
    @Transactional(propagation = Propagation.REQUIRED)
    @Audit(departName = &quot;shops&quot;)
    public ReturnObject findGrouponById(@PathVariable Long shopId, @PathVariable(&quot;id&quot;) Long actId){
<span class="fc" id="L56">        GrouponAct act = this.grouponActService.findByShopIdAndActId(shopId, actId);</span>
<span class="fc" id="L57">        return new ReturnObject(new FullGrouponActVo(act));</span>
    }

    // 商户查询商铺的所有状态团购
    @GetMapping(&quot;/groupons&quot;)
    @Audit(departName = &quot;shops&quot;)
    @Transactional(propagation = Propagation.REQUIRED)
    public ReturnObject retrieveByShopId(@PathVariable Long shopId,
                                         @RequestParam(required = false) Long productId,
                                         @RequestParam(required = false, defaultValue = &quot;1&quot;) Integer status,
                                         @RequestParam(required = false, defaultValue = &quot;1&quot;) Integer page,
                                         @RequestParam(required = false, defaultValue = &quot;10&quot;) Integer pageSize){

<span class="fc" id="L70">        List&lt;GrouponAct&gt; ret = this.grouponActService.retrieveByShopId(shopId, productId, status, page, pageSize);</span>
<span class="fc" id="L71">        log.debug(&quot;retrieveByShopId: ret.size = {}&quot;,ret.size());</span>

<span class="fc" id="L73">        List&lt;SimpleGrouponActVo&gt; grouponActList = ret.stream()</span>
<span class="fc" id="L74">                .map(act -&gt; {</span>
<span class="fc" id="L75">                    List&lt;OnSale&gt; onsaleList = act.getOnsaleList();</span>
<span class="pc bpc" id="L76" title="2 of 4 branches missed.">                    if (!onsaleList.equals(null) &amp;&amp; act.getOnsaleList().size() &gt;= 1) {</span>
                        // 同一个活动中所有时间相同，只需要用第一个进行拷贝时间
<span class="fc" id="L78">                        OnSale onsale = onsaleList.get(0);</span>
<span class="fc" id="L79">                        SimpleGrouponActVo dto = CloneFactory.copy(new SimpleGrouponActVo(), onsale);</span>
<span class="fc" id="L80">                        CloneFactory.copy(dto, act);</span>
<span class="fc" id="L81">                        log.debug(&quot;retrieveByShopId: dto = {}&quot;,dto);</span>
<span class="fc" id="L82">                        return dto;</span>
                    }else{
<span class="nc" id="L84">                        log.error(&quot;retrieveByShopId: only one onsale obj is allowed for groupon act (id = {})&quot;,act.getId());</span>
<span class="nc" id="L85">                        return null;</span>
                    }
<span class="fc" id="L87">                }).collect(Collectors.toList());</span>
<span class="fc" id="L88">        return new ReturnObject(new PageVo(grouponActList, page, pageSize));</span>
    }



    /**
     *  商户新增团购活动
     */
    @PostMapping(&quot;/products/{pid}/groupons&quot;)
    @Audit(departName = &quot;shops&quot;)
    public ReturnObject createGrouponAct(@PathVariable Long shopId,
                                         @PathVariable Long pid,
                                         @Validated(NewGroup.class) @RequestBody GrouponActDto vo,
                                         @LoginUser UserDto user){
<span class="fc" id="L102">        GrouponAct act = CloneFactory.copy(new GrouponAct(), vo);</span>
<span class="fc" id="L103">        act.setShopId(shopId);</span>
<span class="fc" id="L104">        act.setActClass(GrouponAct.ACTCLASS);</span>
<span class="fc" id="L105">        act.setThresholds(vo.getThresholds());</span>
<span class="fc" id="L106">        OnSale onsale =  CloneFactory.copy(new OnSale(), vo);</span>
<span class="fc" id="L107">        onsale.setProductId(pid);</span>
<span class="fc" id="L108">        onsale.setShopId(shopId);</span>
<span class="fc" id="L109">        onsale.setType(OnSale.GROUPON);</span>
<span class="fc" id="L110">        onsale.setDeposit(0L);</span>
<span class="fc" id="L111">        GrouponAct grouponAct =  this.grouponActService.createGrouponAct(act, onsale, user);</span>
<span class="fc" id="L112">        return new ReturnObject(ReturnNo.CREATED, IdNameTypeVo.builder().id(grouponAct.getId()).name(grouponAct.getName()).build());</span>
    }


    /**
     * 商户将产品加入到团购活动中
     * @param shopId
     * @param pid
     * @param id
     * @param vo
     * @param user
     * @return
     */
    @Audit(departName = &quot;shops&quot;)
    @PostMapping(&quot;/products/{pid}/groupons/{id}&quot;)
    public ReturnObject createGrouponAct(@PathVariable Long shopId,
                                         @PathVariable Long pid,
                                         @PathVariable Long id,
                                         @Validated(UpdateGroup.class) @RequestBody OnSaleDto vo,
                                         @LoginUser UserDto user){
<span class="fc" id="L132">        OnSale onsale = CloneFactory.copy(new OnSale(), vo);</span>
<span class="fc" id="L133">        onsale.setProductId(pid);</span>
<span class="fc" id="L134">        onsale.setShopId(shopId);</span>
<span class="fc" id="L135">        GrouponAct grouponAct =  this.grouponActService.addToGrouponAct(id, onsale, user);</span>
<span class="fc" id="L136">        return new ReturnObject(ReturnNo.CREATED, IdNameTypeVo.builder().id(grouponAct.getId()).name(grouponAct.getName()).build());</span>
    }

    /**
     * 将产品上的团购活动取消
     * @param shopId
     * @param pid
     * @param id
     * @param user
     * @return
     */
    @Audit(departName = &quot;shops&quot;)
    @DeleteMapping(&quot;/products/{pid}/groupons/{id}&quot;)
    public ReturnObject cancelProductGrouponAct(@PathVariable Long shopId,
                                                @PathVariable Long pid,
                                                @PathVariable Long id,
                                                @LoginUser UserDto user) {
<span class="fc" id="L153">        this.grouponActService.cancelFromGrouponAct(shopId, id, pid, user);</span>
<span class="fc" id="L154">        return new ReturnObject();</span>
    }

    /**
     * 商户修改团购活动
     */
    @Audit(departName = &quot;shops&quot;)
    @PutMapping(&quot;/groupons/{id}&quot;)
    public ReturnObject updateGrouponAct(@PathVariable Long shopId,
                                         @PathVariable Long id,
                                         @RequestBody GrouponActDto vo,
                                         @LoginUser UserDto user){
<span class="fc" id="L166">        GrouponAct act = CloneFactory.copy(new GrouponAct(), vo);</span>
<span class="fc" id="L167">        act.setShopId(shopId);</span>
<span class="fc" id="L168">        act.setId(id);</span>
<span class="fc" id="L169">        OnSale onsale = CloneFactory.copy(new OnSale(), vo);</span>
<span class="fc" id="L170">        onsale.setId(null);</span>
<span class="fc" id="L171">        onsale.setShopId(shopId);</span>
<span class="fc" id="L172">        this.grouponActService.updateGroupon(act, onsale, user);</span>
<span class="fc" id="L173">        return new ReturnObject();</span>
    }

    /**
     * 商户取消团购活动
     * @param shopId
     * @param id
     * @return
     */
    @Audit(departName = &quot;shops&quot;)
    @DeleteMapping(&quot;/groupons/{id}&quot;)
    public ReturnObject deleteGrouponAct(@PathVariable Long shopId, @PathVariable Long id, UserDto userDto){
<span class="fc" id="L185">        this.grouponActService.cancel(shopId, id, userDto);</span>
<span class="fc" id="L186">        return new ReturnObject();</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>