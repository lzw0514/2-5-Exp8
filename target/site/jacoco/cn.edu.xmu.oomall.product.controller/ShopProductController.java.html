<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ShopProductController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">product</a> &gt; <a href="index.source.html" class="el_package">cn.edu.xmu.oomall.product.controller</a> &gt; <span class="el_source">ShopProductController.java</span></div><h1>ShopProductController.java</h1><pre class="source lang-java linenums">//School of Informatics Xiamen University, GPL-3.0 license
package cn.edu.xmu.oomall.product.controller;


import cn.edu.xmu.javaee.core.aop.Audit;
import cn.edu.xmu.javaee.core.aop.LoginUser;
import cn.edu.xmu.javaee.core.exception.BusinessException;
import cn.edu.xmu.javaee.core.model.ReturnNo;
import cn.edu.xmu.javaee.core.model.ReturnObject;
import cn.edu.xmu.javaee.core.model.vo.IdNameTypeVo;
import cn.edu.xmu.javaee.core.model.dto.UserDto;
import cn.edu.xmu.javaee.core.util.CloneFactory;
import cn.edu.xmu.javaee.core.validation.NewGroup;
import cn.edu.xmu.oomall.product.controller.vo.*;
import cn.edu.xmu.oomall.product.controller.dto.*;
import cn.edu.xmu.javaee.core.model.vo.PageVo;
import cn.edu.xmu.oomall.product.dao.bo.*;
import cn.edu.xmu.oomall.product.service.OnsaleService;
import cn.edu.xmu.oomall.product.service.ProductService;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.transaction.annotation.Propagation;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.transaction.support.TransactionTemplate;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.stream.Collectors;

import static cn.edu.xmu.javaee.core.model.Constants.PLATFORM;

/**
 * 商品控制器
 * @author Ming Qiu
 */
@RestController /*Restful的Controller对象*/
@RequestMapping(value = &quot;/shops/{shopId}&quot;, produces = &quot;application/json;charset=UTF-8&quot;)
@RequiredArgsConstructor
<span class="fc" id="L41">@Slf4j</span>
public class ShopProductController {

    private final OnsaleService onsaleService;
    private final ProductService productService;
    private final TransactionTemplate transactionTemplate;

    @GetMapping(&quot;/onsales/{id}&quot;)
    @Transactional(propagation = Propagation.REQUIRED)
    @Audit(departName = &quot;shops&quot;)
    public ReturnObject getOnsaleById(@PathVariable Long shopId, @PathVariable Long id) {
<span class="fc" id="L52">        OnSale onsale = this.onsaleService.findById(shopId, id);</span>
<span class="fc" id="L53">        return new ReturnObject(CloneFactory.copy(new OnsaleVo(), onsale));</span>
    }

    @PostMapping(&quot;/products/{id}/onsales&quot;)
    @Audit(departName = &quot;shops&quot;)
    public ReturnObject addOnsale(@PathVariable Long shopId,
                                  @PathVariable(&quot;id&quot;) Long id,
                                  @Validated(NewGroup.class) @RequestBody OnSaleDto vo,
                                  @LoginUser UserDto user){

<span class="fc bfc" id="L63" title="All 2 branches covered.">        if (vo.getBeginTime().isAfter(vo.getEndTime())){</span>
<span class="fc" id="L64">            throw new BusinessException(ReturnNo.LATE_BEGINTIME);</span>
        }

<span class="fc bfc" id="L67" title="All 2 branches covered.">        if (null == vo.getPayTime()){</span>
<span class="fc" id="L68">            vo.setPayTime(vo.getBeginTime());</span>
        }

<span class="fc bfc" id="L71" title="All 2 branches covered.">        if (vo.getPayTime().isBefore(vo.getBeginTime())){</span>
<span class="fc" id="L72">            throw new BusinessException(ReturnNo.ADV_SALE_TIMEEARLY);</span>
        }

<span class="fc bfc" id="L75" title="All 2 branches covered.">        if (vo.getPayTime().isAfter(vo.getEndTime())){</span>
<span class="fc" id="L76">            throw new BusinessException(ReturnNo.ADV_SALE_TIMELATE);</span>
        }

<span class="fc" id="L79">        OnSale onsale = CloneFactory.copy(new OnSale(), vo);</span>

<span class="fc" id="L81">        SimpleOnsaleVo dto = this.transactionTemplate.execute(status -&gt; {</span>
<span class="fc" id="L82">            OnSale newOnsale = this.onsaleService.insert(shopId, id, onsale, user);</span>
<span class="fc" id="L83">            SimpleOnsaleVo simpleOnsaleVo = CloneFactory.copy(new SimpleOnsaleVo(), newOnsale);</span>
<span class="fc" id="L84">            return simpleOnsaleVo;</span>
        });

<span class="fc" id="L87">        return new ReturnObject(ReturnNo.CREATED,dto);</span>
    }

    @GetMapping(&quot;/products/{id}/onsales&quot;)
    @Audit(departName = &quot;shops&quot;)
    @Transactional(propagation = Propagation.REQUIRED)
    public ReturnObject getAllOnsale(
            @PathVariable(value = &quot;shopId&quot;,required = true) Long shopId,
            @PathVariable(value = &quot;id&quot;,required = true) Long id,
            @RequestParam(defaultValue = &quot;0&quot;) Integer page,
            @RequestParam(defaultValue = &quot;10&quot;) Integer pageSize
    ){
<span class="fc" id="L99">        List&lt;OnSale&gt; onsales = this.onsaleService.retrieveByProductId(shopId, id, page, pageSize);</span>
<span class="fc" id="L100">        List&lt;SimpleOnsaleVo&gt; ret = onsales.stream().map(obj -&gt; CloneFactory.copy(new SimpleOnsaleVo(), obj)).collect(Collectors.toList());</span>
<span class="fc" id="L101">        return new ReturnObject(new PageVo&lt;&gt;(ret, page, pageSize));</span>
    }

    @DeleteMapping(&quot;/onsales/{id}&quot;)
    @Audit(departName = &quot;shops&quot;)
    public ReturnObject delOnsaleId(
            @PathVariable(&quot;shopId&quot;) Long shopId,
            @PathVariable(&quot;id&quot;) Long id,
            @LoginUser UserDto user
    )
    {
<span class="fc" id="L112">        this.onsaleService.tryToDel(shopId, id, user);</span>
<span class="fc" id="L113">        return new ReturnObject();</span>
    }

    @PutMapping(&quot;/onsales/{id}/cancel&quot;)
    @Audit(departName = &quot;shops&quot;)
    public ReturnObject cancelOnsaleId(
            @PathVariable(&quot;shopId&quot;) Long shopId,
            @PathVariable(&quot;id&quot;) Long id,
            @LoginUser UserDto user
    )
    {
<span class="fc" id="L124">        this.onsaleService.cancel(shopId,id,user);</span>
<span class="fc" id="L125">        return new ReturnObject();</span>
    }

    /**
     * 店家查看货品信息详情
     * @param shopId 店铺id
     * @param id 商品id
     * @return
     */
    @GetMapping(&quot;products/{id}&quot;)
    @Audit(departName = &quot;shops&quot;)
    @Transactional(propagation = Propagation.REQUIRED)
    public ReturnObject getProductId(@PathVariable Long shopId, @PathVariable Long id){
<span class="fc" id="L138">        Product product = this.productService.findProductById(shopId, id);</span>
<span class="fc" id="L139">        return new ReturnObject(new FullProductVo(product));</span>
    }

    /**
     * 店家修改无需审核的货品信息
     * @param shopId 店铺id
     * @param id 商品id
     * @param user 操作者
     * @return
     */
    @PutMapping(&quot;products/{id}&quot;)
    @Audit(departName = &quot;shops&quot;)
    public ReturnObject putProductId(@PathVariable Long shopId, @PathVariable Long id, @LoginUser UserDto user,
                                     @RequestBody @Validated ProductDto dto){


<span class="fc" id="L155">        Product product = CloneFactory.copy(new Product(), dto);</span>
<span class="fc" id="L156">        this.productService.updateProduct(shopId, id, user, product);</span>

<span class="fc" id="L158">        return new ReturnObject();</span>
    }



    /**
     * 查看运费模板用到的商品
     * @param shopId
     * @param id
     * @return
     */
    @GetMapping(&quot;/templates/{id}/products&quot;)
    @Audit(departName = &quot;shops&quot;)
    public ReturnObject getTemplateProduct(@PathVariable Long shopId, @PathVariable Long id,
                                           @RequestParam(required = false,defaultValue = &quot;1&quot;) Integer page,
                                           @RequestParam(required = false,defaultValue = &quot;10&quot;) Integer pageSize){
<span class="fc" id="L174">         List&lt;Product&gt; products = this.productService.getTemplateProduct(shopId, id, page, pageSize);</span>
<span class="pc" id="L175">        List&lt;IdNameTypeVo&gt; collect = products.stream().map(o -&gt; IdNameTypeVo.builder().id(o.getId()).name(o.getName()).build()).collect(Collectors.toList());</span>
<span class="fc" id="L176">        PageVo&lt;IdNameTypeVo&gt; idNameDtoPageDto = new PageVo&lt;&gt;(collect, page, pageSize);</span>
<span class="fc" id="L177">        return new ReturnObject(idNameDtoPageDto);</span>
    }

    /**
     * 查看使用特殊物流货品
     *
     * @param shopId
     * @param id
     * @param page
     * @param pageSize
     * @return
     */
    @GetMapping(&quot;/shoplogistics/{id}/products&quot;)
    @Audit(departName = &quot;shops&quot;)
    public ReturnObject getLogisticsProduct(@PathVariable Long shopId, @PathVariable Long id,
                                            @RequestParam(required = false,defaultValue = &quot;1&quot;) Integer page,
                                            @RequestParam(required = false,defaultValue = &quot;10&quot;) Integer pageSize) {
<span class="fc" id="L194">        List&lt;Product&gt; products = this.productService.getLogisticsProduct(shopId, id, page, pageSize);</span>
<span class="pc" id="L195">        List&lt;IdNameTypeVo&gt; collect = products.stream().map(o -&gt; IdNameTypeVo.builder().id(o.getId()).name(o.getName()).build()).collect(Collectors.toList());</span>
<span class="fc" id="L196">        PageVo&lt;IdNameTypeVo&gt; idNameDtoPageDto = new PageVo&lt;&gt;(collect, page, pageSize);</span>
<span class="fc" id="L197">        return new ReturnObject(idNameDtoPageDto);</span>
    }






    /**
     * 将两个商品设为相关
     * @param shopId
     * @param id
     * @param user
     * @return
     */
    @PostMapping(&quot;/products/{id}/relations&quot;)
    @Audit(departName = &quot;shops&quot;)
    public ReturnObject relateProductId(@PathVariable Long shopId, @PathVariable Long id, @RequestBody @Validated RelateProductDto relateProductDto,
                                        @LoginUser UserDto user){
<span class="nc" id="L216">        this.productService.relateProductId(shopId, id, relateProductDto.getProductId(), user);</span>
<span class="nc" id="L217">        return new ReturnObject();</span>
    }

    /**
     * 将商品取消相关
     * @param shopId
     * @param id
     * @param user
     * @return
     */
    @DeleteMapping(&quot;/products/{id}/relations&quot;)
    @Audit(departName = &quot;shops&quot;)
    public ReturnObject delRelateProduct(@PathVariable Long shopId, @PathVariable Long id, @LoginUser UserDto user){
<span class="fc" id="L230">        this.productService.delRelateProduct(shopId, id, user);</span>
<span class="fc" id="L231">        return new ReturnObject();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>